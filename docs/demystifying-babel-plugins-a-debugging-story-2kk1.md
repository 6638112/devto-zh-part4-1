# 揭开巴别塔插件的神秘面纱:调试故事

> 原文：<https://dev.to/jnielson94/demystifying-babel-plugins-a-debugging-story-2kk1>

*这篇文章之前发表在[jnielson.com](https://jnielson.com/demystifying-babel-plugins-a-debugging-story)上。感谢阅读！*

在本系列的前几篇文章中，[揭秘了](https://jnielson.com/build-tools-demystified-my-thoughts)和[揭秘@babel/preset-env](https://jnielson.com/demystifying-babel-preset-env) 我介绍了我想要涵盖的想法，然后一头扎进`@babel/preset-env`看看我们能学到什么。在这篇文章中，我将对巴别塔插件做一个更一般的处理，尽管我使用的例子主要是`babel-plugin-styled-components`和`@babel/preset-env`，因为它们是我在项目中最常用的。

作为理解更多关于巴别塔插件的一部分，重要的是要认识到，你需要知道的与插件一起工作的事情的数量明显少于你需要写插件的数量。对于编写插件来说，[一定要去看看关于插件的巴别塔手册](https://github.com/jamiebuilds/babel-handbook),但是没有类似的指导手册可以让你使用或理解现有的插件。如果它是按照手册写的，那么你应该已经很扎实了，但是我会假设大多数人还没有通读那本很棒(也很长)的手册。

## 主要概念

巴别塔插件涉及到两个主要概念:[抽象语法树](https://en.wikipedia.org/wiki/Abstract_syntax_tree)和[访问者模式](https://en.wikipedia.org/wiki/Visitor_pattern)。ASTs 的基本思想是将您编写的代码解析为重要的语言结构，并生成一个“节点”树结构，允许您遍历“代码”来操作它。为了操纵它，babel 使用了访问者模式，这种模式基本上允许插件知道所有的节点类型，选择它们关心的节点类型，并对它们做它们自己的事情，然后再把它传回 babel。这两个想法的结合是令人难以置信的强大，并解锁了巴别塔生态系统中存在的广泛的插件。我最熟悉的两个插件是`@babel/preset-env`和`babel-plugin-styled-components`，前面提到过。在`@babel/preset-env`中，有许多插件是基于传递给它的目标来启用的，[更多关于`@babel/preset-env`在这里](https://jnielson.com/demystifying-babel-preset-env)。由于 preset-env 是一个*预置*而不是一个*插件*，严格来说，这篇文章的其余部分将集中在`babel-plugin-styled-components`和我使用它的经历上。

## 使用插件

根据我的经验，插件通常有三种使用方式:

1.  预设的一部分
2.  直接启用语言功能/语法
3.  直接支持库/代码风格

在每一种情况下，你使用插件的方法通常是不同的。在第一种情况下，你经常不知道插件正在被使用。除非你深入研究预设的源代码或依赖项，否则你通常不知道其中包含了哪些插件，以及它们对你的输出有什么影响。在第二种情况下，您包含一个插件，因为您想要在代码库中使用一些新的特性或语法。通常团队会非常严格地评估这些增加的插件，因为插件越多，构建过程就越长(本质上每个插件都运行在整个树上，即使它实际上只在特定的节点上做一些事情)。第三种类型是像`babel-plugin-styled-components`这样的插件，它们支持像 SSR 这样的库的很酷的特性。指出插件的这些不同用途的原因是，如果你遇到问题，它会极大地影响你如何处理插件。

## 尝试使用插件时出现的问题

根据我的经验，你通常会遇到三种问题:

1.  插件没有做你想做的事情
2.  插件做了一些你没想到或不想要的事情
3.  插件在运行

在这三种情况下，您进行调试的方式略有不同。在每种情况下，拥有一个你正在处理的最小的复制品是非常有用的。最小复制使问题更容易被注意和追踪，并且如果您碰巧确定这实际上是项目的问题，可以提交给接受错误报告的项目。当然，在较小的复制品中不会出现问题，但在我见过的大多数情况下，尝试将其归结为尽可能简单的情况是有好处的。一旦你有了一个简单的案例，你可以检查一些事情来找出可能发生的事情。当然，这取决于正在发生的事情，但让我们来看看一些可能性:

### 插件没有做你想让它做的事情

第一种，通常也是最容易注意到的情况是你的插件没有做你期望的事情。我遇到的一个例子是,`ssr`选项翻转为 true 时,`babel-plugin-styled-components`仍然产生类名不匹配警告。这个警告表明在构建过程中有些地方不太对劲，因为`babel-plugin`被设计来为组件的服务器和客户端呈现生成一致的类名。首先，我必须排除这根本不是插件无法运行的问题，这很容易做到，只需深入研究 node_modules 并添加一个简单的 console.log 语句。然后，在花了一些时间试图得到一个最小的复制品之后，我能得到的最小的复制品仍然包括我的代码、一个共享组件库、`babel-plugin-styled-components`和`@babel/preset-env`——如果你问我的话，这不是一个非常小的复制品！但是，当我关闭并重新检查问题时，我意识到我的代码实际上不是问题的一部分，因为它被正确地转换，并且如果共享库代码不存在，它不会产生警告。在这一点上，我知道这不是实际应用程序的问题，所以我能够剥离几乎所有的应用程序，并将其归结为最简单的 Next.js SSR 设置，我可以用最简单的库组件来获得这个问题。玩了一会儿各种插件的选项后，我意识到`babel-plugin-styled-components`实际上并没有访问共享库组件输出的任何节点。由于我们预先构建了共享库组件，结果是我们没有使用`babel-plugin-styled-components`，而是使用`@babel/preset-env`来构建它们。目标([我在 preset-env](https://jnielson.com/demystifying-babel-preset-env) 上的帖子中详细讨论过)被设置为让`@babel/preset-env`转换`babel-plugin-styled-components`寻找的模板文字，并使`babel-plugin-styled-components`不识别共享库中的样式化组件。这意味着它没有做我想要它做的事情，将代码转换成 SSR 兼容的，因为另一个插件之前已经转换了代码。在这种情况下，我了解到顺序对于 babel 插件很重要，因为一个插件可能将一个节点类型转换成不同的类型，导致其他插件期望原始类型不能工作。

### 插件正在做你不想做的事情

与之前讨论的插件没有做你想做的事情相关，但在大多数情况下很难注意到的是，插件做了你不想做的事情。我最近参与了对 storybookjs repo 的一个[问题的调试，在这个问题中，有人遇到了一个`_esmodule`属性被`@babel/preset-env`添加到他们导出的对象中，直到它开始出现在他们的 storybook 中，他们才意识到发生了一些事情。在这种情况下，他们忘记切换并告诉`@babel/preset-env`避免转换模块，因此它正在转换它们。在大多数情况下，这样做很好，但是它确实会导致其他工具的问题，比如 webpack(用于应用程序代码)不能使用像树抖动这样的特性。因此，他们花了几个小时试图调试为什么会发生这种意想不到的事情，归结为一个插件选项。在这个例子中，插件正在做一些他们不想要的事情，但是我需要一些先验知识来知道`_esmodule`是一个属性，被`@babel/preset-env`用来表示它是一个转换后的`esModule`文件。在插件做了你不知道的意想不到的事情的情况下，我发现的识别它的最好方法是偶尔看一下你的巴别塔过程的输出(理想情况下是在缩小/丑化之前),看看是否有你没有预料到的东西，给定你已经使用的选项和目标。我发现一年检查几次就足够了，因为在大多数情况下你的目标和选项不需要改变，但是如果你从不检查，那么很有可能你有一个插件在做你不知道的事情。从好的方面来看，这种类型的问题表明插件实际上正在运行(尽管它可能没有正确配置),所以您可以排除第三种类型的问题！](https://github.com/storybookjs/storybook/issues/7710)

### 插件根本没有运行

有时很难判断你是否有一个插件没有运行，或者一个插件没有做你想做的事情，但是在大多数情况下，调试和查看一个插件是否正在运行是非常容易的。因为这是 JavaScript，我们使用`npm`或`yarn`作为我们的包，你通常可以进入`node_modules`文件夹，编辑构建的库/插件代码，查看它是否在运行——如果它不提供`debug`选项(而`@babel/preset-env`提供了)的话，这尤其有用。在插件无法运行的情况下，通常是配置问题或选择了错误的插件。我在概述文章中简要地谈到了转换和语法插件之间的区别，因为一个插件实际上是调整输出代码，而另一个插件使解析器能够识别输入。我还注意到，转换插件应该为您启用所需的语法插件。因此，在大多数情况下，我看到的这种类型的问题，配置是地方，看看，并确保没有插件运行之前，导致插件你想不运行，或检查，并确保你通过插件的选项是有效和正确的。

## 结论

总的来说，从用户的角度来看，巴别塔插件非常简单。它们被设计成根据定义的用例、选项和构建的目标，将代码转换成其他代码。这些简单的插件已经被构建成预置，使你能够一次打开整个插件列表，并且完全有可能(并且相对简单)构建你自己的预置！它可以是一个像`@babel/preset-env`一样的“智能”预设，也可以是一个简单的预设，可以启用你项目中需要的各种插件。

感谢阅读！我希望你已经学到了一些东西！如果你有，或者如果你有任何意见或建议，请随时联系我。谢谢！

*横幅照片由 undraw.co 提供*