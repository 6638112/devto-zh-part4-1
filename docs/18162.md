# 在电报上创建一个秘密频道

> 原文:[https://dev.to/labunskya/even-more-secret-telegrams-28bf](https://dev.to/labunskya/even-more-secret-telegrams-28bf)

我们过去认为电报是任何信息的可靠和安全的传输媒介。但是在幕后，它有一个相当常见的 a-和对称加密的组合。那有什么好玩的？为什么有人会相信他们给第三方的信息呢？

TL；DR——发明一个用户间相互屏蔽的私人隐蔽通道。

### [](#covert-channels)秘密渠道

在两个用户之间传输数据有许多避免直接接触的方法。您可以使用中间人、加密和隐写方法、广播中继网络以及现有协议的其他扩展。但是，有时仅使用官方记录的功能来建立安全联系是很有用的。或者应该说，设置一个[隐蔽通道](https://en.wikipedia.org/wiki/Covert_channel)。

我们可以在苏联间谍电影《春天的十七个瞬间》中看到这样的例子(这部电影真的很棒，给它一个机会)。在这本书里，安全屋窗户上的一朵花被用来表示间谍的任务是否失败。花本身并不意味着什么:它可以在那里，也可以不在那里，这种共生现象很常见，它只告诉我们主人对花的爱。只有预先确定的解释才能区分间谍收到的信息和随机路过的人收到的信息。

[![](../Images/be5e35a05ce9f66329633795b7a9d6f1.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--v_XIQpGS--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/60q19j5yv9dvm6lj10q1.jpg)

### In-Window-Flower-based 频道中的电报

用同样的原则来组织你自己的秘密通道，你只需要两样东西:一扇窗户和一朵花。这个窗口代表一个你可以改变被其他人看到的状态的对象和花——可能的状态和改变它们的一种方式。

那么 Alice 能在电报中改变什么而 Bob 能看到呢？实际上是很多东西:头像、用户名、上次访问时间等等。但是通常情况下，每个人都可以同时使用这些东西，这就限制了对话的私密性——如果一个人拥有 transition 方法，他就可以读取 Alice 发送的任何内容。令人惊讶的是，不需要任何加密就可以绕过这个限制。

#### [](#im-blocking-you-haha)我挡住你了，哈哈

每个用户都有自己的黑名单，如果这位读者够烦人的话，他应该已经注意到在被屏蔽后，他的非好友“上次访问”状态变成了“上次看到是很久以前”。事实是，他可能几秒钟前还在线，甚至现在就在线，但 Telegram API 不会再将这些信息发送到你的应用程序。这样，它就保护了其他用户的隐私免受不必要的侵犯。作为交换，他们可以看到自己是否被列入黑名单。

### [](#organizing-bits)组织位

发送和接收位的可能性是有趣的，但我们仍然需要描述它的开发机制。Telegram 在被阻止时拒绝通知你，所以每个“接收位”动作应该由接收者(让我们称他为 Bob)初始化，而不依赖于发送者(她将是 Alice)，即由独立的。同样，Alice 和 Bob 应该以相同的频率发出请求。

每个时钟上的位交换算法如下所示:

*   检查发送的位，如果与之前的值不同，则根据某个值对其进行更改:
    *   A -> T:如果 bit 为 1，则阻塞 B；
    *   A -> T:如果位为 0，则解锁 B。
*   b 接收一个位:
    *   B -> T:解析 A；
    *   T -> B:可用于 B 关于 A 的信息；
    *   b:检查接收到的信息是否具有状态 it:
    *   b:如果是->他没有被阻塞，比特为 0
    *   b:如果不是->他被阻塞，位为 1

大多数现代 pc 机都有很好的频率发生器(例如系统时钟)，所以我们可以用它们来同步我们的时钟，而不用信道来传输除了信息位以外的任何东西。唯一值得注意的是，Telegram API 请求，无论是(解除)阻塞还是用户状态解析，都是网络调用，不会很快工作，尤其是当您使用代理或 VPN 时。这产生了一个限制:时钟长度应该比平均响应时间更长(因为我们需要将一个与另一个相适应),这就是为什么我们的数据传输速度会受到限制。

#### [](#encoding-messages)编码消息

自然语言中的文本有相当高的冗余度，收到的有错误的消息对人来说仍然是可读的。由于 Telegram 是一个信使(忽略一些疯狂的东西)，我们可以忽略纠错，将可能传输的数据限制在简单的文本消息中。

我们的通道具有极低的带宽，因此我们需要对可能的消息使用最有效的消息编码。幸运的是，这位信使的名字提醒我们，这是一个常见的问题。

这就是为什么生活在 21 世纪的我们会用一百年前电报员可用的最有效的编码方式之一来编码我们的文本——波德码。更准确地说，它的最终变体 ITA-2 是由[唐纳德·默里](https://en.wikipedia.org/wiki/Donald_Murray_%28inventor%29)创造的，在语言最频繁的符号上执行更少的 API 调用。

成功传输消息剩下的唯一任务是找到会话边界，以便接收方可以在连续的比特流中找到发送的一个。在传输开始之前，Bob 要么被阻塞，要么没有被阻塞，并且这种状态不会在短时间内自行改变。这就是为什么 Alice 可以通过只交换一个时钟来指示会话开始。在会议成功结束时，她将解除他的障碍，平静地离开。另一方面，他将继续接收零比特，直到决定它们不是消息的一部分——波德码没有`00000`符号。

[![](../Images/7d19ce083804144b380af0d351da1b84.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--3fukjlnN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/94bu50eedpqgnuqcopf5.png)

该方法的缺点是实际上不可能连接到正在进行的翻译(可以连接，但是由于位移，可能需要手动纠错),并且需要将接收到的有错误的空符号与发送的空符号分开。但是实施起来有很多问题。

### [](#high-tech)高科技

在花了几个小时尝试使用官方库 API 后，我累了，用更人性化的 [Telethon](https://github.com/LonamiWebs/Telethon) 用 Python 写了所有东西。它甚至有一个同步风格的 API，由于一些奇怪的原因，这在今天已经很少见了。信息编码与 ITA-2 我自己写的，因为没有找到任何有用的在互联网上。

与系统时钟同步(是的，它休眠()s！这是因为考虑到在大多数情况下每个网络 API 调用所需的时间超过十分之一秒，这已经足够精确了。用户可以按照自己的意愿设置传输速度，但如果你不想看到对方出错，并发现自己被防洪系统禁止，我建议你遵循“每秒不超过一个请求”的规则。Telegram 原来对 API 使用非常挑剔，冻结我的访问一天，从甚至几个简单的(成功！)连续的授权尝试，以及在传输过程中由于未知原因对洪泛的随机阻塞。伙计们，你们应该声明你们的 API 使用限制。

如果用户决定使用这样一个怪异的通道来交换消息，他不应该关心任何图形用户界面功能。而且反正不是所有系统都有，所以我用终端工具的形式写我的应用。它允许通过命令行参数中给定的用户 id 经由通道发送和接收消息，但是每次启动只有一个操作。当然，没有人会限制你一次只运行一个程序的副本，并且同时使用多个通道，你只需要用不同的参数运行同一个脚本的几个副本。

#### [](#using-the-stuff)使用货色

你可以通过 GitHub 上的 API(本文末尾链接的库)阅读更多关于使用这个工具作为命令行工具和 python3 库的信息。唯一的问题是获得你自己的 API 证书([简单的手册](https://core.telegram.org/api/obtaining_api_id)就足够了)，因为 Telegram 不允许在你的本地脚本副本中公开我的和设置相应的值。除了授权部分(默认情况下通过 stdio 进行)之外，所有内容都通过命令行参数传递，如下所示:

```
For Alice:                           |        For Bob:
Enter your phone number: XXX         |        Enter your phone number: XXX
Enter auth code: YYY                 |        Enter auth code: YYY
Started message transmission...      |        Listening for the message...
---++ ('O', '9')                     |        ---++ ('O', '9')
--+-+ ('H', '#')                     |        --+-+ ('H', '#')
+++++ (1, 1)                         |        +++++ (1, 1)
--++- ('N', ',')                     |        --++- ('N', ',')
--+-- (' ', ' ')                     |        --+-- (' ', ' ')
++-++ (0, 0)                         |        ++-++ (0, 0)
--+-+ ('H', '#')                     |        --+-+ ('H', '#')
-++-- ('I', '8')                     |        -++-- ('I', '8')
--+-- (' ', ' ')                     |        --+-- (' ', ' ')
--+++ ('M', '.')                     |        --+++ ('M', '.')
++--- ('A', '-')                     |        ++--- ('A', '-')
-+-+- ('R', "'")                     |        -+-+- ('R', "'")
++++- ('K', '(')                     |        ++++- ('K', '(')
+++++ (1, 1)                         |        +++++ (1, 1)
+-++- ('F', '!')                     |        +-++- ('F', '!')
--+++ ('M', '.')                     |        --+++ ('M', '.')
--+++ ('M', '.')                     |        --+++ ('M', '.')
Done, exiting...                     |        ----- ('', '')
                                     |        ----- ('', '')
                                     |        Automatically decoded: OH, HI MARK!.. 
```

收到的消息将被自动解码，但如果你想跟踪进展和/或手动纠正一些错误，看看命令行输出。

### [](#outside-of-the-telegram)电报之外

值得注意的是，有可能在任何信使和/或社交网络上实现上述通道，其中一个人可以检测他是否被其他人阻止。您可以使用我的代码来这样做，而不必重新发明轮子。python 的低性能(与通常的 C/++)不会因为低传输速度和 API 调用响应时间而成为限制因素。

P.S .特别感谢我的激情不一般的爱挡住我
[RU 版](https://habr.com/ru/post/451954/)，[恩镜](https://medium.com/@labunskya/secret-telegrams-bdd2035b6e84)

*   [GitHub](https://github.com/LabunskyA/covertele)