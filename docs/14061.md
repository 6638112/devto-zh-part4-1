# Heroku 如何运营其多租户 Apache Kafka 服务

> 原文:[https://dev . to/heroku/how-heroku-operates-its-multi-tenant-Apache-Kafka-services-2d HP](https://dev.to/heroku/how-heroku-operates-its-multi-tenant-apache-kafka-services-2dhp)

*这篇博文改编自阿里·哈米迪在 2019 年 SF '19 数据大会上的演讲，题为“[在 Heroku](https://www.youtube.com/watch?v=-AtHKoTNR1k) 上为开发者运营多租户 Kafka 服务。”*

[https://www.youtube.com/embed/-AtHKoTNR1k](https://www.youtube.com/embed/-AtHKoTNR1k)

成千上万的开发者使用 Heroku 的 Apache Kafka 服务来处理我们平台上的数百万笔交易——其中许多是通过我们的多租户 Kafka 服务完成的。以这种规模运行 Kafka 集群需要仔细规划，以确保在各种客户用例中的容量和正常运行时间。借助重要的自动化和测试套件，我们无需庞大的运营团队就能做到这一点。

在本帖中，我们将讨论我们如何构建安全、可靠、高效的基础设施来满足您的需求，即使您的事件是在多租户环境中处理的。

## [](#what-is-kafka-used-for)卡夫卡是用来做什么的？

Kafka 是一个分布式流媒体平台，由“生产者”生成信息，“消费者”阅读这些信息。消息存储被写入磁盘，并且高度可用。运行 Kafka 的实例称为代理，多个代理可以充当数据的副本。如果一个代理出现故障，副本将被提升，从而能够在不停机的情况下继续运行。每个 Kafka 集群都带有一个完全托管的 ZooKeeper 集群，它处理这些不同服务的配置和同步，包括访问权限、健康检查和分区管理。

Kafka 是许多数据密集型用例中的关键支持技术。一些客户使用 Kafka 从不同的来源获取大量数据。有些人使用 Kafka 构建事件驱动的架构来实时处理、聚合和操作数据。其他人使用 Kafka 从整体迁移到微服务，在迁移过程中，Kafka 充当处理事件的中介，同时将嵌入式功能提取到较小的服务中。(你可以在我们的博客上阅读关于 SHIFT Commerce 如何做到这一点的全部内容[。)](https://blog.heroku.com/monolithic-applications-into-services)

## Heroku 如何经营卡夫卡

Heroku 的最便宜的单租户计划有三个经纪人。该集群中的一切都属于您，如果性能和隔离对您的应用程序至关重要，这是一个不错的选择。

当然，代价是这些方案往往比我们最便宜的多租户方案贵 15 倍。多租户计划更适合开发和测试环境，甚至是不需要专用集群的巨大能力的应用程序。

我们的多租户计划具有与我们的单租户产品相匹配的功能和操作对等性:它们具有相同数量的代理、相同数量的 ZooKeeper 节点，并且它们的行为方式完全相同。虽然对我们来说，只提供一个经纪人/动物园管理员选项会更划算，但我们觉得我们的用户会开发一些不代表真实生活的东西。相反，我们让您以很低的成本获得代表真实生产集群的东西。例如，如果您的代码只针对单个节点，您就没有机会预测和构建常见的故障场景。当您准备从多租户 Kafka 服务升级到单租户设置时，您的应用程序已经为此做好了准备。

我们还致力于确保无论有多少客户共享一个集群，我们的多租户选项仍然是安全和高性能的。这篇文章的其余部分将详细介绍我们是如何做到这一点的。

## [](#security-through-isolation)安全通过隔离

尽管许多不同的客户可能位于一个多租户 Kafka 集群上，但我们的首要任务是确保没有人能够访问其他人的数据。我们主要通过两种方式做到这一点。

首先，Kafka 有对访问控制列表(ACL)的[支持，并且它是在集群级别执行的。这允许我们指定哪些用户可以对哪些主题执行哪些操作。第二，我们还在每个租户级别命名我们的资源。当你创建一个新的 Kafka 附加组件时，我们会自动生成一个名称并将其与你的帐户相关联，如`wabash-58799`。此后，该资源上的任何活动都只能由您的应用程序访问。这保证了 Heroku 独有的另一层安全。](https://kafka.apache.org/documentation/#security_authz)

单个租户也不应该干扰集群上的任何其他租户，主要是在性能方面。如果另一个 Heroku 用户正在处理大量的事件，你对 Kafka 的使用不会降低。为了减轻这一点，Kafka [支持生产者/消费者的配额](https://kafka.apache.org/documentation/#design_quotas)，我们强制用户每秒可以读写的字节数。这样，无论有多少事件可供处理，集群上的每个用户都可以公平地分配计算资源进行响应。

## [](#keeping-kafka-available)保持卡夫卡可用

当您从 Heroku 购买 Kafka 时，我们会立即提供您购买的全套资源；我们从不走捷径或过度调配工作负载。例如，在存储方面，我们会自动扩展您可用的磁盘空间。如果您达到配额的 80%，我们将扩展硬盘，以便您可以继续向 Kafka 写入数据。我们将继续扩展它(同时向您发送电子邮件提醒您已超出容量)，以便不中断您的工作流程。如果您远远超出了限制而没有解决问题，我们将会限制您的吞吐量，但仍然保持集群的可操作性供您使用。

在许多情况下，为了我们和你，我们设置的默认配置是合理和安全的，甚至经常比 Kafka 最初推荐的还要高。其中一些包括更高的分区设置(从 1 到 8，以最大限度地提高吞吐量)，更多的副本(从 1 到 3，以确保您的数据不会丢失)，以及更多的同步副本(从 1 到 2，以真正确认副本收到写入)。

## [](#applying-our-tests-to-production)将我们的测试应用于生产

我们在各种排列中测试了我们的 Kafka 基础设施，以模拟多租户集群在现实世界中的行为。

为了找到最佳配置并观察 Kafka 的性能如何变化，我们尝试了多种组合，从吞吐量限制到最大分区数。

类似地，我们复制了几个失败场景，以查看服务是否能够经受住意外的变化。我们会用一百万条消息敲打一个集群，然后让其中一个代理离线。或者，我们正常运行一个集群，然后决定停止并重新启动服务器，以验证故障转移过程是否有效。

我们的测试创建了一个空集群，然后生成了 50 个将 Kafka 附加组件附加到他们的应用程序的用户；然后，他们为这些模拟用户创建许多生产者和消费者。在此基础上，我们为每个用户定义使用配置文件。例如，我们会说 10%的用户发送非常小的流量，20%的用户发送非常大的消息但速度非常慢，然后其余的用户进行一些随机的数据分发。通过这一过程，在逐渐增加用户数量的同时，我们能够确定多租户集群的操作限制。

从这些事件和观察中，我们能够识别我们的设置中的问题并调整假设，以真正使基础架构具有弹性，以免它们成为我们用户的问题。为了更深入地了解我们是如何设置所有这些测试和自动化的，我的同事汤姆·克雷福德做了一个名为“[用 5 个人运行数百个 Kafka 集群](https://www.confluent.io/kafka-summit-nyc17/running-hundreds-of-kafka-clusters-with-5-people/inv/)的演讲

## [](#more-information)更多信息

如果你想了解更多关于我们如何操作 Kafka，或者我们的客户用这项服务建立了什么，请查看我们以前的博客文章。或者，你可以[观看这个演示](https://www.heroku.com/kafka#action)，从技术上了解 Heroku 上的 Apache Kafka 能为你做什么。