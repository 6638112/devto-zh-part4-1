# 善待你的日志文件(以及那些阅读它的人)

> 原文:[https://dev . to/scalyr/be-kind-to-your-log-file-and-than-reading-it-575h](https://dev.to/scalyr/be-kind-to-your-log-file-and-those-reading-it-575h)

日志文件从程序员时代就存在了。软件世界发展得非常快，但是不难想象几十年前有人在钻研日志文件。这或许和编程本身一样具有标志性。

但可悲的是，对于许多商店来说，这种方法在这段时间里并没有真正发展。“如果你需要的话，把所有的东西都转储到一个文件中，以后再进行整理”是最初的想法。这种情况一直持续到今天。

换句话说，我们倾向于将日志文件视为编写代码时任何突发奇想的垃圾场。如果有疑问，记录下来。虽然这是一个好的冲动，但它往往会导致“只写一次，永远不读”的结果。如果你曾经通过操作系统日志开始解决一些问题，然后由于不堪重负而放弃，你会明白我的意思。

[![](../Images/4feda1adeb29ccfad9f13399da7579e9.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--WyVVJHQg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://library.scalyr.com/2018/07/19175245/iStock-499691816-300x300.png)

但是，即使你没有，你也可以想象一下。一个日志文件有几十亿字节的神秘、相似的文本页面，阻碍了有意义的故障诊断。阅读它是如此的无聊，以至于你开始发现自己在眨眼之前就被催眠了，心想这不会有所帮助，然后转向其他的故障排除方法。

### 重新思考日志文件

因此，记住这一点，让我们重新考虑日志文件。如今，人们非常注重直观的用户体验，我们可以从中吸取经验。不要把日志文件看作是你的产品代码中每一个错误思想的垃圾场，而要把它看作是*意味着*要被消耗的东西。

谁会阅读您的日志文件？又是为了什么目的？而且，有了这些问题的答案，我们如何能让他们更容易？

这是一个足够重要的考虑因素，因此出现了[产品](https://scalyr.com/product/)来帮助方便使用日志文件，[使故障排除和数据收集更容易](https://www.scalyr.com/blog/five-reasons-need-log-monitoring/)。人们*购买*这些产品是为了让他们的生活更轻松，所以这应该告诉你一些事情。他们迫切希望从噪音中过滤出信号，并从日志中获取有价值的数据。

因此，让我们来看看在写入日志文件时，您可以如何提供帮助。这些工具拥有[复杂的解析能力](https://scalyr.com/product/server-log-parser)，但这并不意味着你不应该尽自己的一份力量来帮助你的日志文件的消费者。以下是你如何做到这一点。

### 记住你的听众

我刚刚谈到了理解人们想要使用日志文件的重要性。但是让我们更具体地说一下。在写入日志时，您需要考虑两个主要因素:

*   人们会在文件中搜索，并在文本编辑器中阅读相关部分。
*   出于各种目的解析文件中条目的程序。

所以当你阅读这篇文章的其余部分时，请记住这一点。您希望以一种人们在阅读日志文件时能够理解的方式写入日志文件，同时也希望解析算法保持简单且易于实现。

### 包括时间戳和标识符

重要的事情先来。对于每个使用日志文件的人来说，它需要一些顺序。

从概念上讲，日志文件包括将一系列*事件*记录到一个文件中。将这些事件视为数据，就像写入数据库一样。现在，这样想，你可能开始理解记录某些数据的必要性。具体来说，您需要一种唯一标识每个事件的方法，并记录事件发生的时间。

记录这些数据对于帮助您重新创建应用程序中发生的事情的准确时间线和顺序至关重要。许多[日志框架](https://scalyr.com/blog/logging-framework/)会为您处理这个问题，但是您需要确保它已经配置并启用。

### 添加上下文

我在一篇关于日志实践的文章中强调了上下文的重要性，但是这里值得重复一下。您需要为您记录的消息提供上下文。假设您添加了时间戳和唯一标识符，但是没有提供上下文。您会看到这样一个条目:

> [10/04/16 14:29:27:122][fbfa 1260-8b 32-4270-8 a54-b09c 8592640d]出现错误。

出现错误？！什么错误？在哪个模块？有什么大不了的吗？是整个应用程序崩溃了，还是只是某个用户在邮政编码字段中输入了“乔·史密斯”？

没有上下文，您的日志条目是没有用的。因此，请确保您为任何人类阅读添加了足够的上下文，以便对发生的事情以及在哪里寻找更多信息有一个好的认识。

### 使用键值对

上下文通常会帮助你的人类读者，但是让我们考虑一下我们的机器消费者。您将如何解析传统的日志文件，我们如何使之变得更简单？

多年来，我一直编写代码来解析上面显示的带有时间戳、ID 和无用错误消息的日志条目。它通常涉及大量的字符串匹配和[正则表达式](https://www.scalyr.com/blog/search-your-files-with-grep-and-regex/)。它还涉及解析固定宽度或空格分隔的文本，这两者都会让你质疑为什么你会决定成为一名程序员。

别让你的消费者这样。键值对使得处理这些文件变得简单了几个数量级，这在概念上并不难做到。可以简单到 timestamp={timestamp}，id={id}等。或者，如果您愿意，可以将日志条目组织成 JSON，让消费者利用现成的解析和文档存储工具。

### 标签和类别条目

虽然我们的主题是将您的日志条目视为数据，但是您也应该对它们进行分类和/或标记。你可能已经直观地理解了这一点。您将在日志文件中看到的最常见的方案是给它们赋予如下的“级别”。

*   调试
*   信息
*   警告
*   错误

但是稍微退后一点，从概念上理解一下，这涉及到什么。您正在对所有条目进行分类，以便稍后进行排序。添加类别让使用文件的人和算法的生活都变得更加轻松。但是您也可以用一个标记方案来扩展它，让您以一种不互相排斥的方式来处理条目。例如，您可以根据哪个应用层生成了事件以及哪个垂直切片生成了事件来标记它们。例如，一个条目可能有标签，“数据访问层”和“更新客户资料”

### 避免发送垃圾日志文件

考虑下面的一小段应用程序代码。

```
public File GetFile()
{
    while (!_fileFetcher.IsReady)
        _logger.Log("Waiting for file fetcher to be ready.");

    return _fileFetcher.FetchFile();
}
```

这里，您有一个阻塞循环，它轮询 this _fileFetcher 以查看它是否准备好了。但是，当它这样做的时候，它用虚假的条目杀死了日志文件，宣布，不，文件提取器还没有准备好。

这是一个相当愚蠢的例子，但这个想法是为了说明一个观点。每当您从应用程序代码写入日志文件时，请确保您不仅考虑了条目看起来是什么样子，还考虑了它将会放入什么内容。你是在提供有价值的信息，还是在垃圾邮件中散布一些你可以更简洁地表达的信息？

### 但是不要忘记任何事情！信息越多越好

我将用一个既实用又有哲理的建议来结束我的演讲。它还假设你已经记住了其他要点。说到日志，信息越多越好。所以，宁可要更多的信息。

如果你真的考虑过你的消费者，包括所有必要的标识符和上下文，使你的条目可解析，标记和分类，并检查垃圾邮件，那么你可以确信你存储了有价值的信息。所以，核对完清单后，如果你对是否要记录事情有疑问，那就记录下来吧！

你所有的努力都是为了让人类和算法更容易地搜索、处理和理解条目。因此，如果你犯了过度包含的错误，过滤掉它们就变得微不足道了，你不需要担心。

几十年来，日志文件已经有了很大的发展，但前提是您要利用现代日志实践和工具。你应该确保你这样做。