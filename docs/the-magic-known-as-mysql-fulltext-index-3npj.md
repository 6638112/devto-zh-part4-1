# 神奇的 MySQL 全文索引。

> 原文：<https://dev.to/leoat12/the-magic-known-as-mysql-fulltext-index-3npj>

我们开发人员大部分时间都在与数据库进行关于性能的斗争。性能问题的根源根深蒂固地存在于您的查询中，这种情况并不罕见。这是我们每天都必须与之抗争的命运。这个星期我不得不与它作斗争，我有一些有趣的结果和新的经历来谈论。就在那时，我发现了名为 MySQL 全文索引的魔力。

## 问题

当你在一家小公司工作时，我们最终会让你涉足不一定是你专长的领域，这就是我作为一名开发人员处理数据库的情况。我不是 DBA，因此我不了解 MySQL 这样的数据库的所有复杂性。当问题出现时，每个人都帮助给出他们的建议，研究等等。这次的问题是关于应用程序的搜索功能的性能。

举一个用例的类似例子，我们有一个查找产品的搜索特性。正如所料，在一个产品中有许多字段你需要搜索以使它尽可能准确，其中一些是产品的名称，它的描述，信息字段，一些关键字，制造商的名称等。只有有了这个描述，我们才能有三个表:

*   产品，不言自明
*   关键字，它有一个单独的表，因为我们可以为多个产品重用。
*   制造商，也是不言自明的。

然而，这里的问题不是连接的数量(有很多，比我在上面的简单例子中描述的要多)，而是给定搜索输入的字段搜索方式。最初，我们在数据库上使用一个函数，该函数利用 REGEXP 来查找完全包含搜索输入的行，也就是说，如果输入是“discount ”,则该列必须包含整个单词“discount ”,才能由数据库带来。好吧，看起来无害，直到它不是。

我仍然不知道为什么，我认为这将是一个很好的理由来研究并在另一个时间发表另一篇文章(如果你有任何想法，为什么让我知道！)，但在划分查询的每个部分并测试所有部分后，我们得出结论，使用这种搜索方法极大地降低了查询的速度，就像，在生产环境中，查询花费了许多秒钟，这是非常糟糕的消息。

为了提供更多的背景信息，使它看起来不像是我们的一个大错误，该系统正在重建，它已经运行了许多年，现在我们正在重塑布局，并实际上用新的技术和解决方案重写后端，但我们仍然使用相同的数据库，许多查询尚未触及。此外，问题出现在最近，可能是因为流量增加。在测试和最初几个月的生产中，它没有被发现，搜索表现相当不错，尽管我们计划进一步加快速度。

## 解

由于我们的时间和预算有限，解决这个问题并不容易，不可能在我们已经拥有的基础设施之外做一些事情，例如，为此添加另一个数据库:我们考虑了 Elasticsearch 甚至任何其他 NoSQL 数据库，如 MongoDB，一些测试表明它会提供良好的性能。然而，添加另一个数据库会增加复杂性，更不用说成本了。由于我们正在重建，我们愿意尝试新技术，但我们添加了 Redis 用于缓存目的，添加另一个数据库会增加太多的成本。

考虑到这一限制，我们唯一能做的就是试图以某种方式使查询更好。我们尝试的第一件事是用 LIKE 替换 REGEXP，尽管性能有所提高，但它并没有带来我们期望的搜索结果。当时我不知道全文索引的存在，也不认为 MySQL 有这样的功能，我总是将全文搜索与 Elasticsearch 和其他以此为主要功能的 NoSQL 数据库联系起来。当我在朋友谷歌上寻找“mysql 全文”时，它出现了有趣的结果。

像其他任何索引一样，你首先创建它，例如:

```
CREATE FULLTEXT INDEX product_search_index ON product(name, description) 
```

然后奇迹开始了。要使用全文索引的功能，您可以使用`MATCH ... AGAINST ...`函数，有一些模式，您可以选择最适合您需求的模式。我仍然在研究所有的模式及其优缺点，但是你可以在[文档](https://dev.mysql.com/doc/refman/8.0/en/fulltext-search.html)中找到所有的解释，现在我将坚持使用`IN NATURAL LANGUAGE MODE`，默认的模式，也是最适合我的用例的模式。引用文档该模式是这样工作的:

> 自然语言搜索将搜索字符串解释为自然人类语言中的短语(自由文本中的短语)。除了双引号(")字符之外，没有特殊的运算符。停用字词表适用。

它在自由文本中查找我们要作为短语查找的单词。MySQL 有一个停用词列表，可以根据您的需要进行配置以改善搜索结果。然后你可以做一个简单的查询来得到结果:

```
SELECT * FROM product WHERE MATCH(name, description) AGAINST ('notebook off discount') 
```

然后，查询将按照相关性的顺序带来搜索结果。此外，与我们之前的产品相比，它的速度非常快。在大多数情况下，我们将查询响应时间从几秒钟缩短到不到 1 秒钟。包括我在内的每个人都对结果感到惊讶。这就像魔术一样，这让我觉得我需要更多的研究来理解他们是如何做到的。

## 结论

令人印象深刻的是，每天你都可以学到新的东西，有时它会出乎意料地成为你一直在寻找的解决方案。有了它，我能够只用我已经拥有的资源解决问题，并且最终不会过度设计解决方案。