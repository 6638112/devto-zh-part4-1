# 在 PHP 中构建自动 API 存根和/或使用模拟

> 原文:[https://dev . to/roelofjanelsinga/building-automatic-API-stubs-and-or-using-mocks-in-PHP-5c 81](https://dev.to/roelofjanelsinga/building-automatic-api-stubs-and-or-using-mocks-in-php-5c81)

[!["Keyboards Black & White"](../Images/20a33492d7314ce05001b0f00671ae9a.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--AXDmEnMY--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/qnkq5gy0kjkdpyfpixfd.jpeg)

# 在 PHP 中构建自动 API 存根和/或使用模拟

如果您想编写不破坏应用程序的代码，测试您的代码是必不可少的。您应该使用测试来确保您的代码做了它应该做的事情，不多也不少。当您拥有与外部服务交互的代码时，测试这些代码变得更加困难。您不负责其他服务的可访问性，但是这些仍然会影响您的应用程序的状态。外部服务或与这些服务的连接中的任何问题，如果它们不可操作，都会破坏您的测试。这并不(总是)代表您的应用程序的实际状态，可能会导致误判。不要误解我的意思，您应该将处理这些问题的场景放在适当的位置，但是它们不应该改变您的测试期望。一个输入应该触发一个特定的反应，一个可预测的反应。

## [](#the-reason-to-build-and-use-an-api-stub-generator)构建和使用 API 存根生成器的原因

我的一些使用 Google 地理编码 API 的单元测试返回了失败的断言。这些测试失败不是因为我们写的代码，而是因为我们的公司搬到了一个新的办公室。这意味着我们的 IP 地址改变了，这就是为什么 Google 使我们的 API 令牌失效了。令牌有 IP 限制，我们不再使用白名单中的 IP 地址访问服务。然后，当我在笔记本电脑上启用 VPN 连接时，我添加了另一层肤色，这使我的 IP 地址无效。事实上，我的测试做出了错误的断言，因为服务不再可访问，这是一个迹象。代码处理了 API 响应，但是没有返回预期的结果。我的代码工作正常，但是测试并没有反映出这一点。

## [](#where-the-automatic-stubs-come-in)哪里来的自动存根

想法是构建一个包来记录您在测试运行期间对外部服务进行的所有 API 调用。我将通过将 URL 和/或请求头与接收到的响应一起保存在一个模拟文件中来做到这一点。这有助于我在实际调用 API 时只运行一次测试，并在以后的测试中返回存根值。因为我在单元测试中测试数据的处理，所以我仍然需要利用这些 API 结果。但是增加的 API 调用并不能证明验收测试的可靠性，而这正是编写测试的目的。

## 为什么使用模拟可能是更好的选择

复制 API 响应的全部目标是获得实际的响应，而不是进行 API 调用。但是，如果你使用部分回答，就像我的情况，完整的回答不是最重要的部分。最重要的部分是对我正在测试的案例的准确的部分响应。我需要能够预测特定 API 响应的特定行为。因此，通过提供带有一些数据的模拟，我可以模拟测试脚本响应所需的确切响应。这允许我为单个输入和单个输出编写可预测的代码和测试。

在这一点上，我不太确定我会选择什么。一旦我实现了一个解决方案，我会更新这篇文章并详细描述这个解决方案。