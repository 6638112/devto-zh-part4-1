# 走向 OpenGL 音乐可视化

> 原文：<https://dev.to/psedge/towards-an-opengl-music-visualiser-155g>

电脑图形太神奇了。我喜欢这种美学，希望有一天我不仅能做出实用的东西，还能变得富有表现力。

我目前的副业是 OpenGL，目的是创建一个实时响应音乐的 3d 演示，其灵感来自驯服的黑斑羚和死灵 5 的视觉效果，为音乐会增添了一个全新的维度。

第一步:想办法制作一个基本的演示。这被证明是如此的复杂以至于可笑——甚至用 OpenGL 用 c++从一个立方体开始也花了几个小时，因为它不是一个立方体，而是 16 个单独的三角形网格，它们有自己的顶点和片段着色器实例、缓冲区和绑定。还有相机，哈！模型空间和世界空间之间到底有什么区别，我如何知道我是需要正交相机还是透视相机？更不用说试图在我试图想象的 x，y，z 空间中找到正确的维度了——每一次重建都需要大约 10 秒钟。最终，我放弃了 c++，因为我对 API 的工作方式以及核心 GPU 架构缺乏基本的了解。这不像我期望的那样，你可以动态地传递对象引用并同时写入多个缓冲区数组，当与 GPU 交互时，你必须按程序做每件事——这很好，但我发现自己花费了太多时间来寻找管理这些事情的正确方法，这令人恼火。这意味着是创造性的。

我遇到过几次 three.js，总觉得 WebGL 能提供这样的性能真是太棒了，所以我蜂拥而至。我们仍然有相同的核心概念——相机、几何、材质、网格、场景；但现在都是用熟悉的语言，瞬间解读。这一步把我从“该死的那个点有点偏了”带到了“看起来不错，我希望它接下来做什么”——这是意料之中的，因为我刚刚在堆栈中上升了几层。最终的结果是 psedge.github.io/demo——一个真正的工作网络“演示”。

达到这一点并不像我想象的那么容易。对我来说，主要的症结在于:

*   *帧速率*:事实证明不同的着色器有不同的性能影响，尽管我一次只处理大约 100 个网格，但使用除了基本材质之外的任何东西都可以将渲染速度降低到一个土豆。这个问题可以通过降低材质或者同时减少可见物体的数量来解决，并且从聚光灯改为平行光(计算起来不那么密集)。
*   *动画速度*:我还是不明白时钟在请求动画帧/渲染中起什么作用。假设我有一个将立方体旋转 90 度的动画——我改变网格旋转并请求一个帧，如果还没有，等待 1000/{FRAME_CAP}ms。然而，在 FPS < FRAME_CAP 的情况下，动画将花费很长时间。如果我们只能得到 30FPS，那么动画将会花费两倍的时间，这对于时间敏感的动画来说是不合适的。我认为解决这个问题的方法是，使旋转成为从我们开始到期望的总时间的函数。我的问题是，我理解这个问题，知道这肯定是一个非常普遍的问题，但不知道如何问。*编辑*没错，这是正确的方法。

*第二步*:获取音频。我在之前的一个项目中看到过 [pulseaudio](https://www.freedesktop.org/wiki/Software/PulseAudio/) ，但那只是用于通过 WiFi 控制 Ubuntu 机器上的音频水平，而不是用于接收音频输入。此时，有必要重新评估 three.js 和 WebGL 的有用性，因为 HTML5 音频 API 可能是一个限制因素。我遇到过这样的例子，请求音频上下文并开始在 Web Worker 中监听，将频率数据传递回图形线程，但缺少 stackoverflow/reddit 帖子使我犹豫这是否很容易实现开箱即用。我不确定是否在本地服务器上这样做，并使用 WebSockets 与 three.js 通信，或者也将图形移动到适当的客户端程序。

*第三步*:分析音频。这就是我完全缺乏信号处理知识的地方。我知道，从技术角度来看，我需要在设定的时间(样本窗口)内记录来自麦克风的音频，然后对其进行快速傅立叶变换，以获得不同频率的幅度。我不知道我将从中获得什么类型的值，或者如何选择频带——应该是固定的还是动态的等等。很明显，在大多数语言中有很多库可以用来做这个，有些专门用于音频分析——但是还需要更多的研究。

*第四步*:获取分析过的音频并在演示中使用。在这一点上，功能需求已经完成，我们已经有了一个工作可视化器的组成部分，我们只需要决定如何处理它。这里的问题是，显然对于温暖的“实时”感觉[，我们需要实现从听到音频到绘制帧的不到 10 毫秒的延迟](https://www.soundonsound.com/techniques/optimising-latency-pc-audio-interface#7)。在我们可能的 60fps 上限下，每 1 毫秒绘制一帧，允许我们的服务器和 WS 连接每秒钟进行大量的 9 毫秒操作。gig 视觉效果可能绕过这一点的方式显然是分析和预渲染视频，然后在播放时同步。

不用说，我真的开始更加欣赏我玩的游戏了。我不知道这个世界有多复杂，也不知道这么多领域需要多少先决知识——不仅仅是软框架知识，还有难懂的数学/力学。我过去总是在旧的 PHPbb 论坛上把游戏设计视为一个元主题，并想知道为什么它如此普遍地被作为一个专门的部分——现在我知道了。此外，我已经决定，我至少喜欢在可视化开发的快速原型阶段使用 three.js，即使出于性能原因需要移植到 c++中——就我个人而言，我觉得这是精神可视化和生产之间的中间阶段。