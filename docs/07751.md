# 快餐车和异步编程

> 原文:[https://dev . to/dealeron/food-trucks-and-async-programming-3 jam](https://dev.to/dealeron/food-trucks-and-async-programming-3jam)

几天前，我们在 DealerOn 举办了“食品卡车日”。一辆烤奶酪食品车在我们洛克维尔的办公室前开了一家店，消息很快传开了。当队伍形成时，卡车后面的一个人接受命令，两个厨师操作煎锅。当收到订单时，他们使用一个“票”队列来跟踪订单，两位厨师同时工作来准备各种烤奶酪。对于这样一个有限的空间，该系统是高效和精心策划的。我突然意识到这是一个异步和并行系统架构的完美例子。我们将使用一个假想的快餐车作为例子，来看看异步、并行和分布式编程的一些概念。

## [](#synchronous)同步

想象一下，一辆只有一名厨师供应汉堡的快餐车。队伍排好了，他们接受你的订单，把肉饼放在烤架上，坐在烤架旁等它烤好，加上小圆面包和配料，端上桌。然后他们从下一个顾客那里接受订单，重复同样的过程。虽然这是最简单的设置，但显然效率低下。当烹饪食物时，厨师和顾客都要花大量时间闲站着，而且厨师一次只能做一个馅饼。点餐需要一些时间，所以每次点餐之间烤架会空几分钟。然而，这是我们编写大多数代码的方式。它在一行中执行，所有的东西都必须等待任何相关的任务完成。

## [](#asynchronous)异步

厨师花很多时间等待食物煮熟。它必须在烤架上烤几分钟，所以在烤架上放上一个肉饼后，厨师离开并接受下一个订单。一打馅饼可以同时放在烤架上，所以厨师可以在第一个正在烹饪的时候开始下一个订单。虽然一个厨师实际上一次只能翻转或端上一个馅饼，但可以同时放多个在烤架上。这现在是一个异步系统。

等待 HTTP 请求、数据库查询或任何其他类型的外部系统是一个赢得时间的机会，而不是在等待任务完成时阻塞。在许多语言中，这是通过`async` / `await`语法来完成的，以声明您正在让工作人员继续其他任务，直到下一步准备好。Javascript 通过单线程事件循环使用这种模型，但要求 API 调用、接受用户输入和其他“等待”操作在完成时有“回调”来异步继续，而不是在浏览器空闲时锁定浏览器。

## [](#parallel)平行

另一种方法是，你可以雇佣第二个厨师，而不是改进一个厨师的工作流程。第二个厨师经历了与第一个例子相同的“单线程”过程，但是两个厨师同时工作。这相当于引入了多线程。工作仍然是一步一步地完成，但有更多的工人并行操作。这是通过在多个线程上运行代码来实现的，这些线程可以在多核系统上同时执行。

## [](#thread-pooling)线程池

当异步编程与并行编程相结合时，您可以两全其美。想象一下，两个厨师都可以四处看看，接下一个订单，做烧烤，或者为顾客服务。每当他们空闲时，他们就寻找下一个需要完成的任务。它们的效率只受到烤架大小的限制。在计算中，并行线程可以被“汇集”成一组工作线程。当一项任务完成后，下一个有空的工人可以继续完成它。许多异步编程语言利用了某种线程池。不同的语言有不同的语义，但是在 C#中，`Task`代表一个工作单元，它可以在运行时管理的线程池上执行，并被异步等待。

## [](#race-conditions)竞赛条件

当两个进程不需要共享资源时，并行是很容易的，但这种情况很少发生。在我们的快餐车的例子中，两个厨师共用一个烤架。通常情况下，这样做很好，但偶尔当卡车繁忙时，一个厨师可能会放下或翻动馅饼，而另一个厨师不会看到。他们不知道哪些馅饼已经在烤架上烤过了，并且烤过头了一些。当这种情况发生在并行系统中时，如果共享内存不是为处理并行请求而设计的，那么它很容易被破坏。这可能导致特别难以诊断的错误，因为它们可能只发生在高并发量的情况下，如生产环境，即使这样也只是非常偶然的。在小型受控开发环境中，几乎不可能重现事件的确切顺序。

## [](#distributed-computing)分布式计算

一旦快餐车减少了空闲时间，剩下的唯一瓶颈就是烤架本身。随着快餐车越来越受欢迎，店主又买了一辆快餐车。每辆新的快餐车都增加了新的烤架和新的厨师。除了能够提供更多的汉堡，如果一辆食品车[坏了](https://www.gofundme.com/gqmr4w-keep-say-cheese-movin039)，仍然可以提供服务。同样，为服务添加额外的服务器实例可以提高性能和系统弹性。当每个实例都可以彼此独立地运行时，这种方式效果最好，就像食品车的情况一样。当您给系统增加网络延迟和可靠性问题时，竞争条件和并发性的复杂性会急剧增加。

* * *

尽管每一步都会增加额外的复杂性，但使系统异步、并行和分布式可以极大地提高其性能和效率。任何空闲的时间都是优化的机会。从食品卡车的生产线到复杂的分布式数据处理系统，核心原则往往保持不变。