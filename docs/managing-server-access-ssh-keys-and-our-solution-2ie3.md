# 管理服务器访问、SSH 密钥和我们的解决方案！

> 原文：<https://dev.to/serverauth/managing-server-access-ssh-keys-and-our-solution-2ie3>

在看到了在一个不断发展的团队中管理 SSH 密钥的复杂性以及 GDPR 的所有新法规之后，我和我的好朋友 Rick 开始尝试解决这个问题。我们的两个工作地点都遭受着管理团队成员 SSH 密钥的痛苦，两者的原因略有不同，一个是较小的团队，但 100%远程，没有 SSH 密钥的实际中央存储，另一个是基于办公室的较大团队，但有许多服务器依赖于服务器部署脚本，每次您想要添加或删除某人的访问权限时，这些脚本都会单独更新和运行。

虽然存储在部署脚本中的 SSH 密钥比什么都没有要好，但是每台服务器都需要一个脚本，因此要修改密钥，您需要在每台服务器上添加或删除密钥，然后等待重建脚本运行，这并不理想——我们都有更好的事情要做！

我们在规划过程的早期就决定，存储 ssh 密钥的中央 API 不需要访问服务器，也不应该知道服务器的任何信息，除了在授予/撤销访问权限时在 GUI 中使用的“服务器名称”标签。我们还希望能够选择服务器上的哪些帐户将由这个集中的 ssh 密钥 api 管理。这就缩小了我们执行这个想法的选择范围，只允许一个代理运行在服务器上，并使用该帐户的惟一密钥调用 api，从而允许我们返回正确的 SSH 密钥。

我们开始测试我们的概念，只是在测试域上放置一个文本文件来复制 api 端点，我们知道我们可以构建一个基于 CRUD 的 GUI 来管理服务器、帐户和 SSH 密钥，这没有问题，但我们主要关心的是能够找到 cron 作业、服务器权限和代理分发方法的正确组合。鉴于我们对 PHP 和 Laravel 框架的了解，我们决定尝试 Laravel Zero(Laravel Zero 是一个控制台框架，使用 Laravel 组件构建)，我们可以轻松地构建在服务器上设置代理配置所需的控制台命令，联系 api 并写入正确的`authorized_keys`文件，以设置服务器上允许的 SSH 密钥。

经过一些试验和错误，我们得到了一切工作，但是我们遇到了一个障碍，主要是因为我们没有正确阅读文档，没有完全理解人们使用他们的服务器的目的。我们使用了 Zero 的内置编译器(它使用了 box under the hood)，创建了一个 PHAR 档案。这可以在 Linux 系统上作为二进制文件执行。然而，我们很快发现，需要安装一个兼容的 php 版本。这并不理想，因为我们需要要求或安装一个特定的 php 版本。这对我们来说有点像死胡同。虽然我们都是 php 开发人员，但显然不是每个人都在使用或希望在他们的服务器上安装 PHP。

考虑到我们想要实现的目标和围绕它的需求，我们意识到 PHP 并不能满足我们的需求，我们需要真正地关注一门不同的语言。经过进一步的研究，我们决定将 Go 作为代理使用的语言，因为它允许我们为所有主要的 Linux 发行版提供预制的二进制文件(以及任何想要手动编译它的人的源代码)。

因此，我们抽签决定，让 Rick 承担学习围棋和创建代理的任务，让我自己构建 api 和应用程序 gui。

## 建筑代理人

分工确定后，Rick 开始遵循 Go 文档，并决定使用 Cobra，这是一个用于构建基于 CLI 的应用程序的很棒的包。这大大加快了开发时间，并允许以最小的代价构建所需的功能。

代理最终变得非常简单。它支持添加新的系统帐户，删除系统帐户，然后同步所有帐户的 ssh 密钥。创建一个配置文件，其中包含为服务器系统帐户运行每个同步命令所需的 api 密钥。然后可以将 sync 命令设置为以 cron 任务的形式频繁运行。

这可能听起来很基本，但这就是我们的意图。我们不想知道连接到 ServerAuth 的服务器的 ip 地址或位置，所以在任何时候都不需要任何服务器细节，我们只需要一个通用名称(尽管这更多是供您自己参考，而不是我们的)。代理位于您的服务器上，并连接到我们，而不是相反。稍后将详细介绍。

## 构建 API & Web App

很明显，我画了创建 GUI / API 的任务。因为我们都知道 Laravel，使用它是显而易见的选择，因为将来我们都可以在必要时进行更新。在启动代理之前，Rick 还整理了 ui 设计。这不仅使我的生活变得更容易，而且因为它是使用 TailwindCSS 构建的，所以做起来非常快！

早期我决定避免用 Javascript 做任何花哨的东西，并决定保持它的简单和功能性。我们总是可以在以后推出更多的铃铛和哨子。

对于 GUI，我们决定让一个用户注册并创建一个团队，然后这个人可以邀请其他人创建一个帐户并加入。每个用户都可以管理他们的 SSH 密钥。如果用户拥有正确的权限，他们就能够“创建服务器”，这只是在我们的数据库中创建一个具有唯一键的行，然后为用户提供在他们的服务器上运行的代码，以设置和配置代理。

一旦配置了服务器，用户就可以在 GUI 中管理该服务器，并将团队中的其他用户分配到服务器上的个人帐户。例如，这将允许您授予团队领导对 root 用户的访问权限，但只授予标准团队成员对他们需要访问的服务器上的用户的访问权限！

接下来显然是实际的 API 端点，除了接收团队、服务器、服务器帐户的唯一密钥，然后返回分配给该服务器帐户的用户的所有 SSH 密钥之外，不需要任何复杂的工作。这将要求每个服务器对 API 管理的每个帐户多次调用 API，但这将使事情更容易处理和安全，而不是单个 API 调用来检索服务器上每个帐户的 SSH 密钥。

从概念证明到工作产品非常快。通过利用开放源码包和现代开发技术，我们已经能够在短短几个月内将概念证明转化为可行的产品。

借助我们内置的 SSH 密钥同步、预定 SSH 访问和一系列其他功能，我们已经能够使 [SSH 访问管理](https://serverauth.com)变得轻松而易于管理！

我们现在处于高级测试阶段，在生产环境中使用 ServerAuth，一切都很好。我们现在希望开放，让更多的人参与进来，消除系统中最后的一些问题，并从其他人那里获得一些重要的反馈，特别是如果这可能让他们的生活变得更容易的话。我们暂时将 ServerAuth 保持为免费服务，但将来可能会考虑为大型组织提供一些付费计划。

如果你在某个地方工作，你觉得会受益于 ServerAuth，我们很乐意与你合作！我们在[https://serverauth.com](https://serverauth.com)整理了一些细节，但如果你想聊天，我们也在 twitter 上( [@MikeBarlow](https://twitter.com/mikebarlow) 、 [@RickMillsUK](https://twitter.com/rickmillsuk) 和 [@ServerAuth](https://twitter.com/serverauth) )。