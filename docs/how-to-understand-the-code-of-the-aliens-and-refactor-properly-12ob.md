# 如何理解外星人的代码并正确重构

> 原文：<https://dev.to/mkdev/how-to-understand-the-code-of-the-aliens-and-refactor-properly-12ob>

### 简介:我们的代号是给谁的？

> 没有什么比临时解决方案更长久的了。
> 
> *—谚语*

任何代码的存在都是为了让某个程序能够执行它。这个程序你怎么写的不重要，但是应该没有错误。如果你同意这一点，那么你和其他许多人一样，误解了编程的整个概念。让我试着解释一下。

在你看来，这些项目有什么共同之处？让我们先把一些显而易见的事情放在一边，比如它是由人用某种编程语言编写的，并且由这种语言的符号组成。我们还剩下一样东西。除了语言之外，程序的文本和书的文本有什么不同？是的，书是用来阅读的，不是用来执行的。但是还有一点不同。任何程序都应该可以修改，以便将来使用！这条规则可以应用于任何东西，从流行的移动应用到操作系统的核心元素。公平地说，一个程序员写的代码在某种程度上也是为其他程序员(或者未来的程序员)设计的。你觉得，我还记得五年前写的代码吗？我甚至不记得半年前做的那个项目了！

> 你的程序的实现应该是清楚的，不仅仅是当你在工作的时候，其他任何可能遇到它的人也是如此

这篇文章不足以涵盖重构和代码架构这样复杂的主题。有很多关于它的有趣的书。我们只是提供你可以前进的方向，让你的代码或者你从其他开发者那里继承的代码变得更好。

### 第一部分:命名

> 这个世界是如此的新，以至于许多事物都没有名字，为了表明它们，有必要指出来
> 
> *—加布里埃尔·加西亚·马尔克斯*

我的一个朋友曾经给我讲过一个相当有趣的故事。他说，那些过于关心安全性的公司的开发人员不知道他们实现的业务逻辑的目的，也不需要知道他们的程序是做什么的。准确地说，他们一定不知道那件事。但是你怎么能在不了解程序功能的情况下创建一个程序呢？该公司雇佣外部分析师，他们的访问级别将高于现场开发人员，正是为了这个目的。

他们有表格，其中包含关于代码中的真实名称和相应名称的信息，他们浏览这些表格，并根据这些表格向开发人员分配任务。例如:“写一个‘func _ 352’函数，它应该取数字‘dep 20’，乘以‘cf 1850’系数，并将结果保存到数据库‘field 255’字段”。函数' func_352 '实际上是做什么的？它从存款中取出金额，乘以年利率，然后存入用户的账户。但是开发人员在创建函数时对此一无所知。

这个例子很简单。但是你能想象一个函数有几十个这样的变量，而一个程序有几千个这样的变量吗？开发速度几乎和你冒险用匈牙利语写故事，和有匈牙利语-英语词典的朋友通电话一样。开发人员在使用别人的错误命名的代码时也会感到困惑。

在编程文献中，你可以找到很多关于如何命名不同种类的软件对象的建议。所有这些建议的主要思想是所有的名字都应该有意义。

> 函数名应该显示它做了什么。变量名应该显示它存储的内容。

你可以很容易地为这样一个简单的函数取一个名字，比如计算用户余额的函数。但是如果你的函数做了更多的操作，你该怎么办呢？这是我们下一部分的内容。

### 第二部分:单一责任原则

> *‘简单比复杂好’*
> 
> *‘复杂比复杂好’*
> 
> *—Python 之禅*

想象一下某个公司的一个惨不忍睹的员工，他需要出具一份货物转移和验收的声明，开车到仓库，从仓库取货，签署一些文件，开车到商店，在商店的货架上展示货物，从供应商那里订购货物并付款，所有这些都应该在今天完成。

有很多人都是这样工作的，没什么不好。但是如果你的业务增长了，你现在有十家商店而不是一家，那该怎么办呢？你会雇佣十个这样的员工吗？在这一点上，雇佣一名会计、一名司机、一名跟单员和一名店员更有意义。

编程也是如此。如果你的程序很小，有这样一个方法是绝对没问题的，因为它几乎不需要计划。但是一旦程序像其他程序一样变大，用例也会变得更加复杂。这时你开始问自己一些问题，比如“我应该如何命名这个 200 行的函数，这样它的名字才能真正有意义？‘尽全力’怎么样？

将这个功能分成更小的功能，每个功能都有特定的用途，这似乎是个好主意。我明白这样的建议听起来显而易见，但是相信我，有些专业开发人员不会这么做。原因是什么？他们懒得重构代码吗？或者可能和外语一样？我们多年来一直在学习这些规则，但是在现实生活中，当谈到谈话时，一切都从我们的头脑中消失了。原因没多大关系。顺其自然吧，那些程序员就是太粗心了。我们继续吗？

有一条很棒的规则:

> **如果你不能为一个函数取一个名字，它需要被重写(分成子函数)**

还有一个:

> **一种功能——一种用途**

### 第三部分:抽象层

> 一个艺术家越是使用这些抽象的形式，他就会越深入和自信地进入抽象的王国
> 
> *—瓦西里·康丁斯基*

任何 IT 产品，无论是网站、移动应用还是电子手表，都是多层抽象的明显例子。例如，你在网站上看到的按钮通过互联网调用代码中的函数。但这仅仅是开始。之后，网站开发者编写的代码使用网站编写语言的库，例如 Python。Python 调用它使用的一些更低级语言的库。在我们的例子中，它是 C++。然后 C++库寻址到汇编程序，操作系统的所有组件都写在汇编程序中。这些组件进行系统调用，通过系统调用，请求将到达 CPU，并在某处被转换为 0 和 1，然后转换为电信号，进行所需的计算。之后，计算结果将以相反的顺序返回相同的步骤。

这是当我们问谷歌二加二等于几时的一个非常简单的表示。实际上，还有更多的阶段。它们是由许多专业人士创造的:物理学家、硬件工程师、操作系统程序员、编程语言的创造者、网站开发者。他们每个人都努力使其他人的工作更容易，这些人以后会使用他们的工作。如今，制作一个网站对我们来说是小菜一碟，因为 99.9%的工作已经为我们完成了。

当我们在项目内部处理代码时，同样的概念也可以应用。您需要根据抽象层来划分代码，因此开发过程不会太困难。每个组件都应该根据它工作的层来“思考”。将用户的邮件保存到数据库的功能不需要知道这个邮件来自哪里:来自网站上的表单，手机 app 或者社交网络。这是更高层所负责的。将电子邮件保存到数据库的功能也是如此。它不需要知道数据具体存储在哪里。这是较低级别负责的，它们存储所使用的数据库的位置和类型。不同的划分抽象层的方法是非常有益的，它使你的开发过程更加容易和快速。

想象一下，你的同事告诉你‘我们需要向移动应用程序发送通知，但我已经这样做了。只需调用我的函数，并将消息文本和用户 ID 传递给它。听起来不错，不是吗？开发人员将通知发送和应用程序的其余逻辑分离开来。现在，该应用程序有一个功能，正是对通知工作，它可以使用。现在试着想象另一种情况。你的同事告诉你‘我们需要向移动应用程序发送通知。我已经为名为 Bill 的用户完成了支付通知。现在我们需要为约翰做同样的事情。

看看我写的函数，用我的例子做你的，但是改变文本和用户 ID。听起来不再那么好了。在这种情况下，您需要检查您同事的代码，复制其中的一些部分，并根据您的目的进行更改和调整。这将花费更多的时间并导致代码重复，这是肯定的。

> 不要把具体的东西和抽象的东西混在一起

如果你单独处理代码，你也需要记住抽象层，因为它有助于你将来的工作。有一个架构设计的概念，要求你的代码为你的客户可能要求的任何改变做好准备。根据抽象层划分软件是损失最小的方法之一。你需要 iPhone 的通知吗？没问题，我们已经为一个机器人做过了。现在我们只需要将通知模块与新平台连接起来，因为我们已经有了通知，所以我们不必再处理它们。这就是它的工作原理。

### 第四部分:干(不要重复自己)

> 至少给他买一件运动衫。我不敢看他。他不再是个孩子了。他不能光着身子到处走。至少给他买件运动衫吧。我不敢看他。他不再是个孩子了。他不能光着身子到处走。
> 
> *——《契诃夫的母题》琪拉·穆拉托娃导演*

干燥——是程序员的黄金法则。它的重要性怎么估计也不过分。大多数编程技术，如抽象、继承、组合、单一责任原则、设计模式和整个 OOP(面向对象编程)范式的存在，使您可以避免代码中的重复。这项任务起初看起来似乎很琐碎，但对开发人员来说可能会变得非常困难。让我们看看它是如何工作的，有哪些类型的重复。

#### 重复值

有这样一种“反设计模式”叫做幻数。假设将 ***价格*** 变量乘以 **0.13** 并写入**税收**变量。在这里我们可以很容易地猜到**税**——是 13%的税率。知道了所得税的税率，我们就明白了 ***价格*** 变量旁边的这个数字是什么意思。然而，这个数字是一个神奇的数字。首先，如果你不知道某个特定国家的税率，你永远不会意识到这个数字是从哪里来的。其次，所得税率可能会改变，在这种情况下，您需要用这个数字重写所有代码部分。

这样的幻数往往会在代码中重复多次。即使现在你的代码中只有一个这样的数字，它也很可能在将来的某个时候重复出现。那么为什么不马上把它变成一个变量呢？！

> **代码中的任何值都不应有重复**

然而，可能会有一些例外。如果该值在不同的地方有不同的含义，您可以复制它。

例如，在一个地方 **0.13** 可能是税率，但在另一个地方也是商品的费用。在这种情况下，数量是相同的，但变量应该是不同的。

#### 重复代码块

很多专业开发人员都会遇到这个问题。假设您需要创建一个与现有过程相似的过程。复制代码块比把它变成一个独立的函数并在你需要的地方调用它要容易得多。但是这种方法可能会导致很多问题！对这个代码块的更改可能需要在您复制代码的两个、三个或更多位置进行。所以，如果你把它变成一个独立的功能，除了没有重复之外，你还会获得其他一些不太明显但却很重要的优势。

遵循单一责任原则意味着您需要将一个单独的代码块变成一个单一的功能。因为这样的块通常有一些特定的目的，所以将它作为一个独立的函数而不是与调用者中的逻辑混合在一起是有意义的。

使代码块成为单个函数使您有机会命名您创建的函数，从而简化代码编写过程。这个名字应该描述函数中的动作，从而使你的代码更加易读。

> **不要重复代码块！使它们成为单独的功能**

#### 重复行为

这种重复是最难发现的。你需要成为一个有经验的开发者来避免它。在“模板方法”设计模式中有一个很好的方法来处理它，所以请花些时间阅读一下。我不打算在本文中彻底解释这种模式的实现。我会给你一些信息，告诉你为什么重复行为是有问题的，以及你如何用下面的方法来消除它。

我们创建的每个任务都可能有几个阶段。我们根据单一责任原则创建这样的阶段。每当您再创建一个任务时，您需要努力记住它是否有与前面阶段相似的阶段。如果是这样，我们可以为我们的任务类定义一个抽象基类，并在其中指定一些阶段及其执行顺序。例如，您可以创建一个公共类来将数据保存到文件中，并将这些数据存储到数据库中。

|  | 关系 | 操作 | 通知 |
| 分贝 | 连接到数据库 | 在数据库中创建记录 | 发送记录已创建的消息 |
| 文件 | 打开文件进行写入 | 在文件中写入文本 |

这里两个任务不仅有共同的行为策略，而且有一个共同的阶段。通过在抽象基类中实现这些任务的行为，您可以将公共阶段的代码转移给它，就像上表中的阶段“通知”中提到的那样。这对共享代码的使用非常方便。基类中常见的相似阶段的分离有助于创建新过程的过程。

> **如果你发现你创建的任务有共同的行为，试着在这些任务的父(基)类中指定它**

### 结论:重构

> “上帝就在细节中。”
> 
> *—路德维希·密斯·凡·德罗等人*

如果你在这里，这意味着通过阅读这篇文章，你已经发现了一些在分析代码时需要注意的基本事情。分析代码和重写代码的某些部分基本上是重构过程的一部分。它的一个主要目的是让你的代码更具可读性，从而更具逻辑性和更高的质量。

你在做谁的代码并不重要，不管是你的还是别人的。花点时间在重构上，会有回报的，我保证当你的应用开始扩展时，代码重构变得必不可少。更改代码的独立部分总是会导致其他部分的更改，有时会导致整个结构的更改。这就是为什么重构是并将永远是工作过程的一部分。在本文中，我试图为您提供几个方向，在这些方向上，您可以正确地进行重构，同时最大限度地减少重构的需要，并为将来分析其他人的代码提供便利。

但是仅仅知道这些规则是远远不够的。完美的代码需要很多时间来变得完美，并按要求工作。即使是最有经验的开发人员也要一遍又一遍地重写他们的功能，直到最终版本稳定为止。

不久前，我与一位艺术家进行了一次对话，他为我的朋友画了一幅令人惊叹的肖像。我完全被它迷住了，所以我问他是如何做到如此相似的。答案很简单:“我只是一遍又一遍地重新画她的脸。”。三次、四次、五次，直到我对结果满意为止。

> 写代码时，力求简单而有意义

使用本文中描述的技术。发明你自己的。帮助他人使他们的代码更具可读性，因为一个旁观者有时可能会做出更好的判断。把你的代码当作一件艺术品，它会工作得很好！

* * *

*这是[一篇由](https://mkdev.me/en/posts/how-to-understand-the-code-of-the-aliens-and-refactor-properly)[阿列克谢·库里列夫](https://mkdev.me/en/mentors)撰写的mkdev 文章。你可以聘请他&我们的其他导师来自己学习编程。*