# 以最短的停机时间迁移电子邮件主机和注册商

> 原文：<https://dev.to/thetomester13/migrating-email-hosts-and-registrars-with-minimal-downtime-3pog>

电子邮件是我们专业在线身份的焦点。不管你喜不喜欢，这是人们与你联系的最可靠、最一致的方式，而且不会很快消失([抱歉，懈怠](https://www.ccn.com/slack-ceo-vows-to-kill-company-email-by-2026-ahead-of-16-billion-float/))。这就是为什么你的电子邮件提供商必须可靠、有弹性，尤其是在当今世界，值得信赖。

最近我意识到我的电子邮件主机并不好。早在我考虑隐私问题或为竞争对手购物之前，我就在那里注册了我的域名并设立了电子邮件账户。他们做的还不错，但他们擅长辅助托管服务，电子邮件显然是事后才想到的，更不用说任何隐私或可扩展性问题了。

我知道我需要迁移电子邮件提供商。我知道这将是一次棘手而复杂的行动。我在寻找的是:

*   最短的停机时间，
*   最终选择我长期信任的供应商，
*   迁移我当前所有的电子邮件和文件夹。

我的域名也是通过同一个电子邮件提供商的主机注册的，我想把它转移到我的日常注册商那里。还不如一下子把所有事情都打掉，下一段时间保持好状态，这样晚上就能睡得安稳，没有后顾之忧了。

### 决定，决定，决定

首先，你必须找到你想迁移到的新的注册商和电子邮件提供商。这涉及到我的一些繁重的研究，因为你不希望不得不多次进行这种迁移。每个人在寻找什么的时候都有自己的优先权；对我来说，这是隐私、管理和支持。那家隐私网站有一篇关于在电子邮件提供商那里寻找什么的很棒的文章，还有一张简单的电子邮件对比图，这是 T2 的。我花了相当多的时间在这些选项中寻找，讽刺的是最终选择了一个甚至不在列表中的主机， [Migadu](https://migadu.com) 。至于注册商，我默认为 Namecheap，因为我已经有相当多的域名在那里注册了，并且喜欢他们的服务。

### 通知您的用户

我非常相信透明度，尤其是在当今的互联网环境下，透明度越高越好。我给该域名的所有活跃用户发了一封信，说明 1)我计划迁移我们的电子邮件提供商及原因，2)迁移到哪个提供商及原因，以及他们应该期望的服务差异，3)预计时间表，以及 4)我需要他们的电子邮件密码。

最后一点是争论的焦点。为了备份和迁移我的用户的电子邮件帐户到一个新的主机，我需要要求他们暂时放弃他们的隐私。因为我是我的用户的日常 IT 人员，他们信任我，并不担心这一点。作为一个很好的措施，我将他们链接到一个页面，在那里他们可以在与我分享之前更改他们的密码，所以如果他们的密码是一个他们经常使用的密码，他们可以将其更改为他们更愿意分享的密码。

也就是说，即使有适当的透明度，也要确保倾听用户的意见，解决他们的问题。如果你提前做了适当的调查，他们应该信任你的转变，但是你要让他们放松，确保他们同意你的计划向前发展。

### 开始备份&迁移(邮件)

我不仅想迁移我当前的电子邮件，还想备份它们，以防出现可怕的错误。事情是这样的，我们的服务器上有很多邮件。我希望这种备份和迁移在稳定的连接上持续运行。AWS 来救援了！我简单地构建了一个运行 Ubuntu 的 t2.micro EC2 实例，并在其上附加了一个 100GB 的块存储。在这一转变过程中，这将是我所有 IMAP(和 SMTP)事务的“指挥中心”。

每个软件成功故事的背后都有一个强大的开源工具。这个故事也不例外。

至于必要的工具，我到处寻找可靠的、稳定的、开源的能够迭代过程的解决方案。我遇到了用于备份电子邮件的 [imap-backup](https://github.com/joeyates/imap-backup) 和用于迁移的 [imapsync](http://imapsync.lamiral.info/) 。一旦您安装了这两个工具，按照它们各自的设置过程，并插入您的用户凭证。

#### IMAP-备份

对于`imap-backup`，您希望您的 config.json 文件看起来像这样:

```
{
  "accounts": [
    {
      "username": "username@domain.com",
      "password": "",
      "local_path": "/ext_vol_data/username_domain",
      "folders": [

      ],
      "server": "imap.server.com"
    }
  ],
  "debug": true
} 
```

当然，一定要正确填写数值。您可以将`folders`数组留空来移动所有文件夹。这里的`local_path`当前指向一个我挂载到 EC2 实例上的 [EBS 商店。我将`debug`设置为 true，这样我就可以通过它的输出来监控脚本的进度。然后，只需在您的电子邮件域上为每个用户创建 1 个`account`对象。](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html)

由于这只是备份我们的帐户，您可以立即开始运行它！这个脚本迭代工作，所以你只需要做一次“完整”备份，之后每次它将只下载差异。

#### imapsync

一旦`imapsync`被正确安装，我发现[这个 Github Gist](https://gist.github.com/onlime/4bc4514e835d7c4d685f) 可以帮助一次同步多个账户。对于多个帐户，只需用正确的凭证复制`accounts.list`文件中的行。确保在 imapsync.sh 文件中正确设置了`CONFIGURATION`变量。这个脚本现在可以运行了，但是在两台主机都设置好并准备好接收请求之前，它不会运行。更多关于这方面的内容将在后面介绍。

### 开始备份&迁移(托管)

我正在迁移的域名也碰巧有 2 个不同的网站托管在它的 2 个子域名上，我想随身携带。确保您为此做好准备，选择一个新的主机，并确保您的环境、数据库和源代码都已备份，并且可以在新的主机环境中运行。

在实际迁移之前，采取您需要的任何措施来尝试并启动它。这比电子邮件迁移更容易，因为您可以在多台服务器上设置同一个站点，但一次只能有一台电子邮件主机！理想情况下，您的站点应该被迁移，只需等待 DNS 更改生效。

### 配置新的邮件主机

因为我不仅要迁移电子邮件主机，还要迁移注册服务商，所以在我确定新的电子邮件主机方面一切正常之前，我不能启动域名迁移。我联系了 Migadu 的支持人员，他们和我一起“启用”了我的域名，尽管它还没有被转移。他们还给了我一个 1 个月的免费试用“基本”帐户，所以我可以看到服务的全部范围。

使用这个，我能够确保新的电子邮件主机启动并运行。

我用模板密码为 Migadu 上的所有用户创建了电子邮件帐户，我可以在他们第一次登录时提供给他们。我还为每个人设置了别名电子邮件地址(这样人们就可以使用像`name+service@domain.com`这样的电子邮件)。

“+”电子邮件别名的正则表达式:`^username\+(.+)@domain.com`

因为我知道已经启动了原来的电子邮件主机和新的电子邮件主机，所以我能够使用`imapsync`开始将所有数据传输到新的电子邮件主机。通过适当的配置，前面提到的`imapsync.sh`脚本使传输变得平滑无缝，迁移各自文件夹中的所有电子邮件，并且是增量式的。

### 行政事务

如果您还计划将您的域名转让给新的注册商，请确保该域名的“网站管理员”电子邮件是您可以访问的电子邮件，并且与您要迁移的域名无关。

### 扣动扳机

好了，现在一切都准备好了。剩下的实际上是扣动扳机，开始迁移过程。选择一个周五或周六晚上，一个相对安静的晚上收发电子邮件，以便在出现任何问题时将“爆炸半径”降至最低。同样，出于透明的目的，当你计划这样做时，一定要通知你的用户，这样如果他们看到任何可疑的事情，他们就知道你在幕后工作。

在正式开始传输过程之前，请确保最后一次运行`imapsync`和`imap-backup`命令，以确保每台主机上的邮箱和备份尽可能保持最新。

现在，开始将域名转让给新的注册商。您可以通过访问新注册商的“域名迁移”页面来完成此操作。您需要从之前的注册商处“解锁”您的域名，并记下域名代码以进行转让。

一旦被触发，就要留意从你以前的注册商那里传来的任何电子邮件。很多时候，他们会在转账之前与你确认。

现在，您应该开始在新的注册商上为您的域配置任何 MX 和 DNS 设置。MX 记录是最重要的，不要让你的电子邮件帐户停机。一旦这些都完成了，一定要为你在域中托管的站点设置你可能需要的任何其他 DNS 记录，并将域名服务器指向新的 web 主机。

是时候确保一切正常工作了！

在您选择的邮件客户端中，更新您的电子邮件设置，以指向具有更新凭据的新电子邮件主机。你应该注意到的第一件事是，你的收件箱和所有其他文件夹应该如你所料地出现，谢谢`imapsync`！现在，从您的任何其他电子邮件地址撰写一封电子邮件到您刚刚转移的域上的电子邮件，并确保它能够通过 IMAP 正常工作。从您新转移的域名向您的另一个电子邮件帐户发送电子邮件——SMTP 工作正常。

通知您的用户迁移已经完成，并向他们提供新主机的设置(IMAP 和 SMTP 服务器、端口等)和新密码。当然，除了他们的电子邮件 [![🙂](img/c1766ba8b46615e3a821a99042b0d85a.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--2EAkP1Kt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s.w.oimg/core/emoji/12.0.0-1/72x72/1f642.png) 之外，你还必须通过其他方式来完成这项工作。确保将他们指向他们需要的设置页面，以便将他们的密码更新为个人的和独特的。

一旦您确定您的电子邮件正常工作，请务必测试您迁移的任何托管网站及其所有功能，因为它们现在生活在一个新的环境中。

### 一切都是为了客户

跟进你的用户，以确保一切都按照他们的预期运行。这也是一个与他们交谈的好机会，看看他们对整个过程的感受:过程顺利吗？痛苦？还有什么比这更好的呢？希望你不需要再这样做了，但是一般来说，得到这种类型的反馈是有好处的。

### 清理干净

因此，现在你应该确保你所有的电子邮件和网站都正确迁移，并按预期工作。

剩下的就是清理了，清理和设置一样重要！不要把这个从你的清单上划掉，直到你彻底清理完你可能已经做过的所有工作。在开始之前，我仍然会等上几个星期左右，以确保在你回不去之前一切就绪，但一定要给自己设置一个提醒，这样你就不会忘记。

我们的主要清理工作包括对 EC2 和 Block Store 中的所有电子邮件备份运行`rm -rf`。确保对所有的设置和配置文件都这样做，因为您的用户(以及您自己的)密码都在那里！现在，您可以放心地拆除这些资源，因为您知道您的信息只存在于新主机的服务器上。

### 余波

唷！为自己出色的工作给自己一点鼓励！

确保你和你的新主人有一个真实的付费账户，以保持良好的关系，不要让试用期在没有意识到的情况下终止。

就是这样！祝贺您成功完成迁移，并以最短的停机时间顺利完成迁移！

图片由[网站主持](https://unsplash.com/@webhost?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/search/photos/server-migration?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄