# 迁移到云但不搞砸，或者如何搬家

> 原文：<https://dev.to/victoria/migrating-to-the-cloud-but-without-screwing-it-up-or-how-to-move-house-546f>

对于一个随时可以扩展的应用程序来说，现在不使用托管云架构就像坚持自己挖井取水一样。这需要更多的劳动力，需要购买所有自己的设备，需要更多的时间，而且你出错的可能性更大，因为你个人没有太多挖井的经验。

也就是说——让我们先解决这个问题——没有云。只是别人的电脑。

当然，如今，云服务已经远远超出了我们对单台电脑的期望。除了能够快速设置和利用以前需要新的办公室租赁协议才能容纳的那种计算能力之外，现在我们的指尖上有大量的监控、管理和分析工具。虽然理解云并非在所有情况下都是更好的选择很重要，但对于可以利用云的应用程序，我们可以做得更多、更快，并且比我们坚持构建自己的内部基础架构花费更少的钱。

这很好，说起来容易；然而，迁移到云从一开始就看起来是一项非常艰巨的任务。确切地说，我们如何着手将可能是多年的内部数据和构建的系统转移到其他人的电脑上？你知道，在看不到它、摸不到它、也不完全搞砸我们的东西的情况下。

虽然这可能比在内部建立或维护相同的架构需要更少的工作和资金，但最初迁移到云确实需要一些工作。重要的是，我们的应用程序要做好迁移准备，并且一旦迁移成功，就能够利用云服务的优势。为了实现这一点和平稳过渡，准备是关键。事实上，这很像搬新房子。

[![Cartoon](img/12cf85000100bb4a4ad82c76d41cac62.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--4ERXepr2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://victoria.dev/verbose/migrating-to-the-cloud-but-without-screwing-it-up-or-how-to-move-house/cover_hu9516d7166362a6834fd7ca185e602fb0_827135_640x0_resize_box_2.png)

在本文中，我们将从较高的层次来了解将本地或自托管应用程序迁移到云的一般阶段。本指南旨在作为针对您的特定情况设计适当流程的起点，并使您能够更好地理解云迁移流程。虽然云迁移对于某些应用程序来说可能不是最佳选择——比如没有可扩展架构的应用程序或者需要大量计算资源的应用程序——但是大多数模块化的现代应用程序都会从迁移到云上受益。

正如我在最近由[亚马逊网络服务](https://aws.amazon.com/) (AWS)解决方案架构师举办的一次活动中发现的那样，平稳高效地进行迁移，对客户的可用性损失几乎为零，这当然是可能的。我将特别提到 AWS 提供的一些服务，但是，类似的功能也可以在其他云提供商那里找到。我发现 AWS 的产品在范围上是令人愉快的模块化，这就是为什么我自己使用它们，也是为什么它们是讨论一般概念的好例子。

为了让我们的搬迁尽可能顺利，我们需要考虑以下事项:

1.  我们正在采取的行动的类型；
2.  我们要带走的东西，和我们要清理的东西；
3.  如何为我们正在迁移的基础架构选择正确的类型和规模；和
4.  如何为大日子做测试练习？

## 我们正在采取的行动类型

虽然理解我们为什么要将应用程序迁移到云服务很重要，但是我们也应该知道我们希望应用程序迁移到云服务时是什么样子。迁移到云有三种主要方式:重新托管、重新平台化或重新分解。

### 重新主持

重新托管是最直接的移动方式。它不涉及我们的应用程序的构建方式或运行方式的改变。例如，如果我们目前使用 Python 代码，使用 PostgreSQL，并使用 Apache 为我们的应用程序提供服务，那么主机迁移将意味着我们使用所有相同的组件，以相同的方式组合，只是现在它们在云中。这很像搬进一个新房子，它的平面图和现在的一模一样。所有的家具都放在同一个房间里，当我们到达那里时，会感觉很熟悉。

迁移主机的主要好处是，它可以提供最少的复杂性，以便利用云优势。例如，可伸缩的应用程序可以获得自动管理必要应用程序资源的能力。

虽然重新托管使伸缩更加自动化，但重要的是要注意，它本身并不会使应用程序可伸缩。如果应用程序基础架构的组织方式不能使其具备伸缩能力，则可能需要重新调整。

### 重新站台

如果我们当前应用程序设置的某个组件不太适合我们，我们可能需要重新搭建平台。在这种情况下，我们至少对架构的一个组件进行了更改；例如，在亚马逊关系数据库服务 (RDS)上，将我们的数据库从 Oracle 切换到 MySQL。

就像从东京的一个小公寓搬到纽约的一个同样小的公寓一样，一个 re-platform 不会改变我们的应用程序的基本性质，但是会改变它的外观和环境。在数据库变更示例中，我们将拥有所有相同的数据，只是组织或格式稍有不同。在大多数情况下，我们不必手动进行这些更改。像亚马逊数据库迁移服务(DMS)这样的工具可以帮助我们无缝地将数据转移到新的数据库。

我们可能会重新搭建平台，以便能够更好地满足未来的业务需求，例如向上扩展、与其他技术组件集成，或者选择更现代的技术堆栈。

### 重因子

我们重新调整应用程序的迁移必然比我们的其他选项更复杂，但是，它可能为有理由进行这种迁移的公司或应用程序提供最大的整体利益。与代码一样，当为了让我们的应用程序满足业务需求而需要进行根本性的改变时，就要进行重构。具体细节必然会因情况而异，但通常会涉及到架构组件或这些组件如何相互关联的更改。这种类型的迁移还可能涉及更改应用程序代码，以便优化应用程序在云环境中的性能。我们可以把它想象成从父母在郊区的地下室里搬出去，在城市里拥有一栋漂亮的联排别墅。我们不可能拿走那张旧沙发，所以我们需要一些新家具，为了邻居的缘故，可能还需要窗饰。

重构可以让我们更新一个过时的应用程序，或者让它更有效率。随着效率的提高，我们可以更好地利用云提供商通常提供的服务，如爆发资源或获得深入的分析洞察力。

如果有必要进行重组，但时间有限，最好先进行重组或平台重组，然后再进行重组。这样，我们就可以在以后很好地完成工作，而不是很快地进行草率、拙劣的迁移(以及更多的问题)。

## 拿什么，收拾什么

在一个地方生活多年后，东西往往会堆积在不为人知的角落和缝隙里。搬家时，这通常是一个很好的机会来整理所有的东西，决定哪些东西足够有用可以保留，哪些东西应该丢弃或送人。对于我们的应用程序来说，迁移到云也是一个做同样事情的好机会。

虽然云存储现在很便宜，但有些东西可能不再存储有意义，或者至少不要与我们的主要应用程序一起存储。如果由于政策或法规而无法丢弃数据，我们可能会选择不同的存储类别来存放我们预计不会在主应用程序之外很快需要的数据。

在[亚马逊的简单存储服务](https://aws.amazon.com/s3/) (S3)的情况下，我们可以选择使用不同的[存储类](https://aws.amazon.com/s3/storage-classes/)来实现这个目标。虽然我们的业务每天所依赖的数据可以利用 99.99%可用性的标准类别，但意味着长期冷存储(如归档备份)的数据可以放入 Glacier 类别，这种类别具有更长的检索时间和更低的成本。

## 正确的类型和尺寸

选择适合我们业务的云基础架构的类型和规模通常是最令人困惑的部分。我们应该如何预测，在一个新的环境中或者对于一个成长中的公司，我们将需要的计算能力？

不自行采购硬件的好处之一是，我们不必做出这样的预测。使用云存储和实例，扩展或缩减资源可以在几分钟甚至几秒钟内完成。借助托管服务，我们甚至可以自动完成这项工作。在我们的应用程序中有了对可伸缩性的适当支持，就像有了一个神奇的房子，可以立即生成我们当时需要的任何类型的房间和舒适设施。持续确保我们使用适当的、经济高效的资源的能力唾手可得，并且通常在图表和仪表盘中清晰可见。

对于新的云应用程序，一些实验的余地可能是必要的。虽然云服务使我们能够快速启动并尝试不同的架构，但不能保证所有这些设置都适用于我们的应用程序。例如，运行单个实例可能比无服务器便宜，但是在我们尝试之前，我们很难知道这一点。

首先，我们只需要足够的存储和计算能力来支持当前运行的应用程序。例如，在存储的情况下，考虑当前数据库的大小——实际的数据库数据，而不是本地硬件的总存储容量。对于详细的成本探索，AWS 甚至提供了一个[简单的月度计算器](https://calculator.s3.amazonaws.com/index.html)和用例样本来帮助指导预期。

## 在大日子之前做试运行

运行试用云迁移可能是一个奇怪的概念，但它是确保迁移按计划进行且服务中断最小化的一个重要组成部分。想象一下，如果我们能够自动化测试运行，在移动房屋的例子中会节省多少时间和精力！总有一些盒子或仍然挂着的照片被遗忘在主卡车外面，需要乘坐其他车辆进行额外的旅行。我们有多种机会来确保一切顺利，从而最大限度地降低了我们的行动对日常业务造成任何影响的可能性。

通常，为了进行测试运行，我们创建应用程序的一个复制版本。我们复制的越多，测试运行就越彻底，尤其是当我们的数据特别大的时候。虽然复制可能看起来很乏味，但是使用我们打算迁移的实际组件对于确保迁移按计划进行是至关重要的。毕竟，如果我们只用一个盒子做搬家测试，那就不太具有代表性。

测试运行有助于针对我们可能遇到的任何挑战来验证我们的迁移计划。这些挑战可能包括:

*   停机时间限制；
*   对传输中的数据以及静止在目标上的数据立即进行加密；
*   到新目标模式的模式转换(AWS 模式转换工具也有帮助)；
*   对数据库的访问，例如通过防火墙或 VPNs
*   开发一个流程来确保所有数据成功迁移，例如通过使用哈希函数。

测试运行还有助于我们更准确地了解迁移所需的总时间，并为我们提供微调的机会。可能影响迁移总体速度的因素包括:

*   源实例和目标实例的大小；
*   移动数据的可用带宽；
*   架构配置；和
*   源上的事务压力，例如数据的更改和传入事务的数量。

一旦通过一个或多个[选项](https://aws.amazon.com/cloud-data-migration/)迁移了重复的应用程序，我们就对现在运行在云中的应用程序进行测试，以确保它按预期执行。理想情况下，在重要的一天，我们将遵循相同的一般流程来移动最新的重复数据，然后无缝地将“真正的”应用程序或网址指向云中的新位置。这意味着我们的客户几乎没有停机时间；本质上，仅仅是位置指向的变化需要传播到他们的设备的时间量。

在有许多组件或许多团队同时一起工作的非常大或复杂的应用程序的情况下，更渐进的方法可能比“大爆炸”方法更合适，并且可能有助于减轻任何中断的风险。这意味着分阶段、一个组件接一个组件地进行迁移，并在不同阶段之间运行测试，以确保应用程序的所有部分都按照预期相互通信。

## 准备工作对顺利迁移至关重要

我希望这篇文章对如何实现云迁移有了更实际的理解。有了充分的准备，就有可能利用云所提供的一切优势，并以最少的麻烦达到目的。

感谢 AWS Solutions Architects 出席 Pop-Up Loft 并分享他们在这些主题上的知识，特别感谢 Chandra Kapireddy、Stephen Moon、John Franklin、Michael Alpaugh 和 Priyanka Mahankali。

来自 John 的最后一个智慧:“朋友不会让朋友使用 DMS 来创建模式对象。”