# 任何人都可能有糟糕的一天

> 原文：<https://dev.to/foospidy/anyone-can-have-a-bad-day-433o>

([照片来源](https://www.washingtonpost.com/sports/nationals/stephen-strasburg-nationals-blow-lead-in-ninth-rally-to-beat-cubs-5-4-in-13-innings/2013/08/22/d6b022a8-0b72-11e3-b87c-476db8ac34cd_story.html))

任何人都会有糟糕的一天。以职业棒球为例，联盟中表现最好的投手。这位投手可能在这个球季的大部分时间里都不适合投球，但是有一场比赛，他就是找不到好球带，或者对方球队轻松地击球得分。昨天，CDN 提供商 Cloudflare 经历了糟糕的一天，因为服务中断导致客户停机约 30 分钟。在棒球比赛中，糟糕的一天的根源是精神上的，这是不容易避免的。然而，在技术上，我们有更好的机会来避免测试和我们选择实现的技术的糟糕一天。在这篇文章中，我强调了 Cloudflare 中断的根本原因，但此外，我还讨论了我们选择云的风险。

## 停电

正如 Cloudflare 的博客中所描述的那样，有一个全球软件部署导致了 CPU 峰值，或者用他们的话说，“CPU 利用率的大规模峰值”。这种 CPU 的过度消耗限制了它们处理请求的能力，实际上是拒绝服务(DoS)。因此，所有试图访问 Cloudflare 前端站点的用户都会收到 502 错误网关错误响应。

## 起因

导致软件部署中断的背景是 Cloudflare Web 应用程序防火墙(WAF)。具体来说，这是一个特殊的 WAF 规则，正如博客的更新所述，“这次停机的原因是在新的 Cloudflare Web 应用程序防火墙(WAF)的例行部署期间，在 Cloudflare WAF 管理的规则中部署了一个错误配置的规则。”该规则包含导致 CPU 峰值的错误正则表达式。正则表达式是定义文本搜索模式的字符序列。传统上，WAF 技术使用正则表达式来搜索应用程序输入，以找到与攻击有效负载的签名相匹配的模式。正则表达式可以非常复杂，这当然需要 CPU 来处理。越复杂，需要的 CPU 就越多。复杂正则表达式的一个风险是正则表达式拒绝服务(ReDoS)。易受重做影响的正则表达式将需要很长时间来计算，消耗 CPU 时间，并且对系统性能有害。尚不清楚这是否是 Cloudflare 的确切问题，但肯定的是，发生了类似的事情。

在继续之前，我想强调这篇文章并不是对 Cloudflare 的批评。虽然我受雇于 Cloudflare WAF 的竞争对手 Signal Sciences，但我也是 Cloudflare 免费层服务在我个人网站项目上的用户。虽然我没有明确利用他们 WAF，但我使用 Signal Sciences 作为我的 WAF。在我看来，事件发生了，公司如何应对很重要。我认为 Cloudflare 很快就进行了沟通和解决，并发布了有关该事件的信息更新。对我来说，鉴于目前不幸的情况，这似乎是一个很好的回应。回应的最后一部分将是如何改变以避免事件重演。不管怎样，这篇文章的重点是任何人都可能有糟糕的一天，现在让我们转向更多的主题。

## 根本原因

退一步说，我认为有一个更广泛的问题是此次事件的根本原因。这是 WAF 技术本身，而且是传统的 WAF 技术。传统 WAF 解决方案攻击检测的主要机制是正则表达式。这导致安全控制具有很高的误报风险，如果处于阻止模式，可能会破坏应用程序，或者使分析师不堪重负而发出无效警报。此外，随着时间的推移，正则表达式的复杂性最终变得非常难以维护，在最坏的情况下，还会带来重做的风险。必须做出不幸的权衡，要么降低成本以避免麻烦和风险，要么投入大量时间和资源以确保有效性和效率，并有望降低停机风险。在当今的现代网络、业务驱动因素和威胁的世界中，这不是安全团队应该被迫纠结的权衡。从长远来看，这简直是无法承受的。不幸的是，Cloudflare 以及所有其他 WAF 技术主要基于传统的正则表达式方法。

另一个强调风险的数据是 ModSecurity 核心规则集项目中最近几个与重做相关的 CVE。一共五份简历。ModSecurity 是几乎所有传统 WAF 产品的基础技术。如果您现在使用 WAF 产品，但不确定它基于什么技术，您应该询问您的提供商。如果答案包含 ModSecurity 或正则表达式，要注意风险。总的来说，对于一个安全控制者来说，这不是一个好故事。

## 云中断

这一事件以及其他类似事件的另一个风险是云服务中断。现在，我们的企业比以往任何时候都更加依赖云提供商及其服务。他们的中断意味着我们的中断。对云服务的依赖只会增加，变得更加重要。从表面上看，我认为大多数互联网用户以及我们的网站和应用程序已经接受了中断的可能性，甚至在一定程度上接受了这一事实。虽然这样的事件对于提供商来说是尴尬的，并且对于用户来说是不方便的，但是任何愤怒都会平息，并且该事件会在几个月甚至几周内被遗忘。对于像 Cloudflare 这样的 30 分钟停机，可能会出现这种情况。

然而，作为一家依赖云服务的企业，您需要从成本和机会损失的角度了解影响。了解风险。风险实现事件的一些影响是什么？这真的取决于你的在线业务的背景，你应该明白什么对你的业务是重要的。对于一个低流量的网站，30 分钟可能不是什么大事。但是一个小时、两个小时、六个小时或者更长时间呢？你对停机时间的容忍度是多少？对于一个高流量的网站来说，30 分钟肯定是一件大事。超过这个时间框架的任何事情只会加剧影响。

可以考虑的几个具体例子是:

1.  新用户注册。如果一个用户试图在你的网站上创建一个新的帐户，但是由于中断而无法创建，他们可能会去找竞争对手。为了帮助衡量这种风险，您需要跟踪一段时间内新用户注册的平均频率。一个简单的例子是平均每天有 25 个新用户注册。

2.  金融交易。特别是购买或任何影响你底线的东西。为了帮助衡量这种风险，您需要跟踪一段时间内的平均交易数量。更具体地说，还要跟踪交易的平均值。

这是两个影响很大的例子，但是您的业务应用程序可能有更多。从这些例子中，我想强调两个要点。第一点是缓解，第二点是检测您的应用程序，以便您可以知道和理解停机的影响。

减轻云中断的影响与您可能已经计划的灾难恢复并没有太大的不同。这里的关键是，有一个计划。在云世界中，这可能意味着为您的应用程序部署实施多云解决方案。你要问自己的问题是，你在云提供商 A 上的云部署能够无缝快速地部署到云提供商 B 吗？这意味着您已经建立了帐户和资源调配，并且拥有支持无缝迁移的流程编排工具。当然，多云解决方案会为您的云计划带来额外的成本，但这应该与您对停机的容忍度进行权衡。

我关于应用程序仪表化的第二点是关于测量和理解您对中断的容忍度。与测量用户注册、登录或高风险事务的频率相比，对应用程序进行检测的能力有着更多的好处。这种能力可以获得非常显著的威胁效益和缓解效益。话虽如此，插装让您能够了解对您的业务以及数据来说什么是重要的。没有这些数据，您就无法准确地评估您的风险，而这对于适当地规划云中断缓解是必要的。

## 结论

停电发生了！这是云生活的事实。随着时间的推移，云提供商将继续提高服务的稳健性，因此我们可以预计停机很少会发生。然而，这并不意味着依靠云提供商来确保我们在线业务的稳健性是合适的。这是你的责任。如果您使用的是传统 WAF 技术，显然您应该考虑 Signal Sciences 等现代 WAF，它有助于消除与基于正则表达式的攻击检测相关的风险。此外，规划云弹性，这可能意味着一个多云解决方案。最后，应用程序的仪表化对于获得理解现代 web 中的业务风险和保护应用程序所需的可见性是至关重要的。