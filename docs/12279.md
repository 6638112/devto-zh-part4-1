# 触发 Lambda 功能时出现间歇性 RDS 错误

> 原文：<https://dev.to/ethanbray/intermittent-rds-errors-when-triggering-lambda-functions-16j7>

近年来，我们开始将基础设施从 OVH 等专用主机转移到 AWS 等云提供商。现在这篇文章不是关于云提供商的利弊，虽然有很多，而是我们在结合使用 AWS [RDS](https://aws.amazon.com/rds/) 和 AWS [Lambda](https://aws.amazon.com/lambda/) 时面临的一个具体问题。

我们将用户详细信息存储在 RDS 实例中，然后由内部 API 使用。我们还有一个 Elasticsearch 集群，它存储某些修改过的用户信息，用于分析和其他目的。MySQL 触发器用于调用 Lambda 函数，该函数将用户信息的修改版本上传到我们的 Elasticsearch 集群。

起初，这个系统似乎运行得很好。事实上，我们有许多其他 RDS 实例每天成功触发 Lambda 函数数百次。然而，很明显，MySQL 触发器偶尔会失败，导致我们的 Elasticsearch 中的数据过时。这个问题似乎是随机的。尽管尝试了各种方法，我们还是无法一致地复制它。我们删除了触发器以消除它对我们的生产基础设施的影响，并创建了 RDS 实例的克隆以供测试。这是我们在设法打破扳机时面临的错误:

> 无法执行语句(42000 - 1064 -未知触发器的主体中有一个错误:“拒绝访问；您需要(至少一个)调用 Lambda 权限来执行此操作')

拒绝访问，怎么可能只在部分时间发生？我检查了我们的集群是否具有正确的 IAM 角色以及正确的 VPC 安全组。它们与我们的工作实例相同。在谷歌上搜索这个问题并没有发现任何与我们有相似症状的人，只有当他们错误配置了他们的 IAM 角色时出现了相同的错误信息。我们被难住了。

在阅读 RDS 上 MySQL 触发器的文档时，我们注意到我们使用的是 MySQL 版本 5.6，而 RDS 现在也支持 5.7。文档中没有提到我们可能会因为版本差异而面临这个问题，但是我们认为无论如何都应该进行升级。私下里，我们希望这也能让我们的问题消失。升级已执行，并且...我们的引爆器还在坏掉。

此时，我们决定呼叫后援并联系 AWS 支持。实际上，我们早就应该这样做了。我们开了一张票，解释了我们的问题和我们得到的错误信息，以及我们已经尝试的事情。

现在介绍一下 AWS 基础设施的一些背景。我们的基础设施在一个 [VPC](https://aws.amazon.com/vpc/) 中，因此我们可以定义安全组和对资源的访问控制列表。我们在这个 VPC 中有几个子网，其中三个可以访问 NAT 网关。NAT 网关允许我们的私有实例在不暴露私有 IP 的情况下访问互联网。我们有三个子网的原因是子网是特定于可用性区域的，在伦敦地区有三个可用性区域。

在等待 AWS 的回复时，我将一个工作中的 RDS 实例的配置与我们的用户信息实例进行了比较，感觉这已经是第一百次了。突然我发现，我们的用户信息实例只在子网`a`和`b`中。有没有可能是子网导致了这些偶然的错误？遗憾的是，您不能修改现有 RDS 实例的子网，因此我创建了一个实例的新克隆，并配置了所有 3 个子网。

一旦我们的新测试实例准备好了，我就创建了我们的触发器并开始测试它们。他们每次都成功了。然后，我明白了这个问题随机出现的原因是我们的请求在 3 个子网之间进行了负载平衡。任何对子网`c`的请求都会失败，导致触发器调用的成功率为 66%。

我们用正确的子网重新创建了我们的 RDS 实例，并将我们的应用程序指向新的主机，永久地解决了这个问题。

回过头来看，问题和解决方案似乎显而易见。当时，这让我们感到困惑，尤其是因为我们在网上找不到任何类似的案例。