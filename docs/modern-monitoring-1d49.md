# 现代监控

> 原文：<https://dev.to/jccguimaraes/modern-monitoring-1d49>

# 目录

*   [摘要](#abstract)
*   [概念](#the-concept)
*   [监控](#monitoring)
*   [结论](#conclusion)

# 摘要

我想分享我在处理微服务和/或 lambdas 等监控应用时的经验，以及过多的监控(或缺乏监控)如何在不仅仅是分析或漂亮的仪表板的方面产生影响。

如果你对这里描述的概念有其他意见，我鼓励你提供建设性的反馈，这样我也可以学习其他人的想法和想法。

> 意见是我自己的，不是我雇主的。

# 概念

监控是日志记录和添加指标的结合，但通常，它们被视为我们应用程序的独立领域，而事实上它们可以一起工作，我们可以利用这种结合。

我们可以用详细的日志来补充触发警报的指标，而不是记录一切(这是不健康的)并为一切(也是不健康的)添加指标。*这是现代监控！*

# 监控

简而言之，*日志*表示不能分组的信息，但它们提供了关于已发生事件的唯一细节，而*度量*表示可以按事件分组的信息，但不提供唯一细节。

假设一个`HTTP`请求返回了一个`404`状态代码。我们可以使用一个名为`clientError`的计数器度量作为例子，每当另一个`4xx`错误发生时，它将继续递增。可以记录单个错误的详细信息，为故障排除提供更多信息。您可以通过时间戳将它们关联起来。

考虑上述错误是由对`my-service`应用程序的以下`HTTP/1.1`请求引起的:

```
GET /my-path?id=my-resource HTTP/1.1
Host: www.my-host.com
Content-Type: application/json 
```

及其对应的响应:

```
HTTP/1.1 404 NOT FOUND
Date: Wed, 17 Jun 2019 10:36:20 GMT
Server: Apache/2.2.14 (Win32) 
```

如果您的应用程序在处理完请求后，记录如下内容:

```
{  "app"  :  "my-service",  "xcid"  :  "uuid",  "time"  :  "2019-07-17T10:36:19.000Z",  "host"  :  "www.my-host.com",  "method"  :  "get",  "path"  :  "my-path",  "statusCode"  :  404,  "msg"  :  "client error"  } 
```

将是一种资源浪费，因为它不提供任何价值来了解发生这种情况的原因！

尽管下一个日志可能会为我们提供数据来了解事件发生的原因，但它会泄漏敏感数据，应该避免:

> 我们**应该**只记录有助于识别**为什么**某个事件会发生的信息，而不暴露合理的数据。

```
{  "app"  :  "my-service",  "xcid"  :  "uuid",  "time"  :  "2019-07-17T10:36:20.000Z",  "host"  :  "www.my-host.com",  "method"  :  "get",  "path"  :  "my-path",  "statusCode"  :  404,  "msg"  :  "client error",  "data":  {  "status"  :  "deleted",  "sensibleKey1"  :  "sensibleValue1",  "sensibleKey2"  :  "sensibleValue2"  }  } 
```

第三个日志条目示例可以提供有价值的信息来理解为什么会发生此事件。

```
{  "app"  :  "my-service",  "xcid"  :  "uuid",  "time"  :  "2019-07-17T10:36:20.000Z",  "host"  :  "www.my-host.com",  "method"  :  "get",  "path"  :  "my-path",  "statusCode"  :  404,  "msg"  :  "'my-resource' does not exist"  } 
```

这种细微的差别使您可以在不暴露敏感数据的情况下调查资源被删除的原因。

底线:

*   指标`clientError`触发了事件警报；
*   日志条目提供了发生此事的原因。

现在，我们已经掌握了在监控范围之外解决该事件的所有信息。

> 这是一个非常简单的例子，但是它显示了我们需要如何根据情况和业务价值来衡量指标和日志。
> 
> 日志应该告诉您事件发生的原因，但不解释它发生的具体原因，否则您将面临再次暴露敏感数据的风险。

没有必要拥有没有任何用途的日志，它们只会让你或你的公司损失金钱。

如果您的应用程序在高可用性应用程序之后，它很可能是由某种负载平衡器/自动伸缩组备份的，或者您只是自己旋转一些容器，您的应用程序**应该**只记录不期望的退出代码。

当您的服务负载很重时，它们会增加更多的容器，当负载下降时，容器会减少。同样，记录这些可预测的关闭不会有任何有意义的信息。

> 当容器被命令关闭时，AWS 和/或 Kubernetes 设置退出代码，允许应用程序读取该代码并记录有意义的信息。

拥有可预测的日志对象还可以帮助您管理和估计所选择的 LMS 日志管理服务的每日服务容量。这跟这里描述的[不一样](#monitoring)。

什么应该代表一个指标？

*   仪表板的商业价值；
*   触发警报的信息(单独或与其他指标聚合)。

一些 LMS 可以在指标中添加维度/标签/标识，这很好，但是在成本方面可能会变成一场噩梦。

添加维度的一个不好的例子是`hostname`，相反，它**应该**是日志的一部分(如果应用的话)。

您的应用程序正在运行的地方是一个很好的维度(如果应用的话),因为它可以提供关于哪些区域一些服务有更多负载的洞察。

> 最终，这是成本和商业价值之间的权衡。

指标及其维度的任何唯一组合都代表一个新的时间序列，这将增加存储在您的提供程序中的数据量。同样，这也增加了总成本。

> 维度**必须**有一个*低基数*。高基数意味着维度将有许多不同的值。

# 结论

我们不应该急于为所有事情添加日志和指标。我们试图在开发过程中发现问题和错误，但是我们肯定会让它们在产品中到处游荡。

这不是一个火了就忘的话题。让它们保持正常，最重要的是，保持安全，并为监控范围之外的正确故障排除提供最少的信息。