# 了解 Azure Cosmos DB 中的分区

> 原文:[https://dev . to/will velida/understanding-partitioning-in-azure-cosmos-d b-1 o7l](https://dev.to/willvelida/understanding-partitioning-in-azure-cosmos-db-1o7l)

[![](../Images/7eff16ac8dfab3fecb7dcb3d8ce410c2.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--9pi6q0rU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/650/0%2AOIzTefJpPbkiSUCf.jpg)

如果你考虑为你的应用程序使用 Azure Cosmos DB，你需要理解分区是如何工作的，以确保你不会受到性能问题的困扰，比如节流。通过有效的分区策略，我们可以确保我们的 Cosmos 数据库能够满足我们的应用程序的性能需求。但是在 Cosmos DB 中分区是如何工作的呢？

为了扩展数据库中的容器以满足应用程序所需的性能要求，Cosmos DB 使用了分区。我们的容器中的项目被划分为逻辑分区，这些分区基于我们与容器中的每个项目相关联的分区键。

假设我们有一个存放单个新闻故事的故事容器，我们有一个新闻类别的分区键，并且新闻类别有 10 个唯一值，那么将为故事容器创建 10 个逻辑分区。

除了分区键，容器中的每个项目都有一个项目 ID，它在逻辑分区中是唯一的。项目索引是这个值与分区键的组合。

正如您可能从我们的介绍中猜到的，选择分区键对我们的应用程序的性能至关重要。因此，让我们来看看可以用来确保选择有效分区键的一些策略:

*   正如我在上一篇关于 Cosmos DB 吞吐量的博文中提到的，对同一个分区键的请求不能超过我们提供给容器或数据库的吞吐量。如果我们这样做，我们会得到一些节流。分区键也是如此。如果我们选择一个具有很少不同值的分区键，或者如果一个值比其他值出现得更频繁，这将导致“*热分区*”。在这种情况下，一个分区会以牺牲其他分区的值为代价，独占 Cosmos 事务所需的吞吐量。
*   为了避免“*热分区*”，我们需要选择一个分区键，该键具有广泛的值，这些值均匀地分布在逻辑分区上。这确保了吞吐量和存储在我们的逻辑分区中均匀分布。
*   选择一个具有大范围值的分区键有助于我们随着时间的推移平衡我们的工作负载。 [Azure 文档声明](https://docs.microsoft.com/en-us/azure/cosmos-db/partitioning-overview#choose-partitionkey)我们选择的分区键应该是高效查询和事务与跨分区分发项目的总体目标之间的折衷。
*   一个好的分区键应该是我们在 Cosmos DB 查询中经常用作过滤器的属性。
*   选择正确的分区键可以让我们有效地控制逻辑分区的数量、数据分布、吞吐量和工作负载。

**管理逻辑分区**

如果您想知道我们需要如何在我们的 Cosmos DB 帐户中放置我们的逻辑分区，您不应该这样想。Cosmos DB 自动完成这项工作，以确保容器的性能。由于我们的应用程序需要更多的吞吐量和存储，Cosmos 移动逻辑分区，将负载分散到更多的服务器上。

这是通过使用**基于散列的分区**将逻辑分区分布在物理分区上来实现的。项目的分区键值被散列，并确定物理分区。然后，Cosmos 将在物理分区之间平均分配散列的密钥空间。访问单个逻辑分区内的数据的查询将比访问多个分区的查询更具成本效益。

**逻辑分区和物理分区有什么区别**

逻辑分区是由一组具有相同分区键的项目组成的分区。因此，使用我们的新闻故事容器示例，假设我们的所有项目都有一个“*类别*”属性，我们可以使用它作为分区键。假设我们有“*体育*”、“*科技*”和“*金融*”类别的值，这些项目组将形成它们自己独特的逻辑分区。如果我们需要从分区中删除底层数据，我们不需要自己删除分区。

当我们向容器中添加数据时，吞吐量和数据会根据我们在容器上设置的分区键在一组逻辑分区中进行水平分区。

物理分区是我们的逻辑分区映射到的分区。它位于一个副本集中，每个副本集托管一个 Cosmos DB 引擎实例。这确保了存储在每个物理分区中的数据是持久的、一致的和高度可用的。

<figure>[![](../Images/2a3782037208f907af9c46503acac832.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--5dqhkt5O--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/0%2AxUwSkZ4uKf2J-5Dn.png) 

<figcaption>展示逻辑分区如何映射到物理分区的简单图表(:D)</figcaption>

</figure>

物理分区支持最大数量的存储和请求单元。每个副本都继承了分区的存储配额，并且所有副本共同支持物理分区上调配的吞吐量。

物理分区是系统的内部实现，这意味着我们不能控制它们的大小、位置或数量。我们也不能控制逻辑分区和物理分区之间的映射。

什么是合成分区键，它在什么情况下有帮助？

如果您知道要存储在容器中的项目是什么样子，并且您的理想分区键不太可能有许多不同的值，我们可以创建合成分区键来帮助我们使用一些策略确保我们的容器不会受到热分区的影响。

我们可以将项目的多个属性组合成一个单独的分区键属性，称为合成键。假设我们的新闻故事容器中的新闻条目文档如下所示: