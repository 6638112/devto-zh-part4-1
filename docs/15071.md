# 侦探系列-网站关闭

> 原文:[https://dev . to/nirmal _ Kumar/detective-series-website-down-50l 1](https://dev.to/nirmal_kumar/detective-series-website-down-50l1)

# [](#detective-angadh)侦探安加德

让我们看看 **Angadh** ，我们的侦探大师(虚构人物)是如何解决一个小公司 ABC 的网站宕机超过一周的案件的。

### [](#case-details-)案例详情:

ABC 代理经营活动和广告业务的小公司。他们构建了一个内部 web 应用程序，并且已经平稳运行了两年多。突然，网站无法访问/关闭超过 1 周。最初，他们有一个开发人员负责所有的开发工作和这个应用程序的部署。不幸的是，开发人员已经不在 ABC 公司了，最终用户也不知道应用程序托管或开发或源代码相关的细节。现在，他们面临着压力，业务连续性完全中断。

### [](#current-state-)当前状态:

ABC 不知道如何解决问题并使网站正常运行。即使他们找到了一些主题专家，他们也帮不上忙，因为 ABC 没有任何关于应用程序代码、数据库或托管细节的信息。

最后，美国广播公司联系了我们的侦探大师安加德，用他们现有的信息解决了这个问题。可用信息是他们开发的内部 app 的域名。

**域名**:digital-agency.abc.com

 **### [](#investigation-)调查:

在回顾了案例研究之后，Angadh 准备了以下列表，通过一个可能的原因列表和故障排除清单来弄清楚后面发生了什么

**网站宕机的可能原因:**(典型的用户较少的网站)

1.  DNS 解决问题
2.  DDOS 攻击
3.  服务器关闭
4.  Web 服务器可能已停止
5.  后台进程可能已经崩溃
6.  可能是基于日期的许可相关问题
7.  服务器 IP 地址更改

**清单:**

Angadh 认为识别问题的唯一方法是获取服务器的详细信息，并访问它们以进一步排除故障。

清单:**确定服务器、主机和源代码**

*   [x]确定网站的 IP 地址
*   [x]确定应用程序的托管位置。(即服务器是本地场所/云的情况)
*   [x]确定应用平台(PHP、NodeJS 等)
*   [x]确定他们使用的是 Apache、PHP-FPM 还是 NGIX
*   [x]确定他们是否有源代码存储库

Angadh 使用以下工具清理上述清单。

**A)** **服务器在哪里&所在地？**

*   从终端 Ping 网站域名。砰
*   [Ping.eu](http://ping.eu) 追踪 DNS 路由
*   使用 IPLocation 的 IPLocation

借助这些工具， **Angadh** 识别出应用程序托管在一个云平台(Google Cloud)上，以及来自 DNS 的 IP 地址详情

**B)如何进入服务器？**

**Angadh** 询问 ABC 的系统管理员他们是否有谷歌云平台的账户，他获得了 GCP 平台的只读访问权限。他看到几个服务器在那里运行，并使用 VM 实例 IP(从清单 A 中收集的公共 IP 地址)，他通过 SSH 连接到服务器。

他很清楚，默认情况下，GCP 将允许您通过 ssh 访问 Linux 实例，方法是为登录并有权访问 GCP 项目帐户的相应用户注入动态密钥。

他觉得自己已经非常接近解决方案了，并且正在尝试探索服务器上的文件和目录。

**C)什么是 App 平台&源代码库在哪里？**

查看源代码可以给出一些关于构建应用程序的平台的提示。Angadh 询问同一个系统管理员他们是否有 GitHub，TFS，BitBucket 等的账户。系统管理员提到他有一个 BitBucket 帐户，并提供了访问权限。 **Angadh** 研究了资源库，确定了合适的项目，并意识到平台是建立在 NodeJS 之上的

**D)这个 NodeJS Web App 是如何在 80 端口服务的？**

/var/www/html 是大多数平台使用的流行目录路径之一。Angadh 试图将目录切换到那个文件夹，但他什么也找不到。目录是空的。

弄清楚这些文件在哪里以及这些文件是如何被提供的将是一场噩梦。根据代码，它默认为端口 8080。但是在某种程度上，他们会通过 80 端口覆盖生产服务器，或者他们会使用 NGINX 或 Apache 代理进行反向代理。他认为这些服务要么停止，要么因为一些意想不到的原因而崩溃。

在服务器进程中找不到任何 apache 或 nginx 服务器。因此，该应用程序通过不同的机制在 80 端口提供服务。

他甚至尝试使用 CURL 命令来判断网站是否在服务器内部工作。

```
$ curl http://digital-agency.abc.com

Could not resolve host: digital-agency.abc.com

 $ curl http://localhost:80 
Failed to connect to localhost port 80: Connection refused

$ curl http://localhost:8080
<html>
.....
.....
</html> 
```

万岁，Angadh 很高兴看到当他使用 curl 命令时得到了一些响应。现在什么反向代理运行在 80 端口的服务器后面。

**E)时间旅行-终端命令历史**

看着目前收集的信息状态， **Angadh** 意识到解决问题的唯一方法是找出老开发者最近在服务器中执行的命令。

```
$ /etc/passwd 
```

上面的命令列出了一些用户。使用 su，他尝试切换到该用户并执行 history 命令

```
$ history > command-history.txt 
```

这一条命令将所有命令导出到一个文本文件中，Angadh 耐心地查看了每一条命令，他惊讶地发现最后一条命令用在了用户 shell 中。

```
sudo iptables -t nat -I PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080 
```

当他看到这一条命令时，他意识到该应用程序不是通过 Apache 或 Nginx 这样的传统 web 服务器提供服务的，而是直接使用 EXPRESS NodeJS 服务器，并使用 iptables(Linux 发行版中使用规则路由 IP 请求的功能)进行重新路由

现在，Angadh 再次执行该命令，并尝试访问该网站，他能够顺利访问该网站。

**F)最后一部分——为什么网站现在上线了？**

在执行这个命令之后，对这个具有 80 端口的服务器的请求被重定向到 NodeJS 8080 端口，之前失败的唯一可能的原因是他们没有将这个更改保存在 IPTable 中。

永久保存 IPTable 规则的命令

```
# https://unix.stackexchange.com/questions/52376/why-do-iptables-rules-disappear-when-restarting-my-debian-system
sh -c "iptables-save > /etc/iptables.rules" 
```

**Angadh** 怀疑出现此问题是由于在 GCP 运行的虚拟机实例中应用了一些服务器重启或补丁。他访问了虚拟机实例，检查了上次启动时间，正好是报告网站关闭后的第 9 天。

```
 $ last reboot 
```

最后，Angadh 总结了网站关闭的根本原因，并尝试重新启动，因为他非常确定 IPTables 是按照之前的命令保存的。重启后，WebApp 运行良好，他向 ABC 提供了一份详细的报告，该公司非常高兴他在短时间内破解了所有这些问题，并使他们的业务再次运行。

Angadh 很清楚使用 IPTables 实现的解决方案并不是健壮的方式。但他的重点是调查和解决当前环境中的问题，这种环境已经运行了一年多。

希望你喜欢这个安加德侦探系列。**