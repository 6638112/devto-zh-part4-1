# Sql Server 多列索引改进

> 原文：<https://dev.to/akashkava/sql-server-multi-column-index-improvements-2mde>

# 多列索引

多列索引是改进查询以降低连接成本的好方法，但理想情况下，超过 3 列会导致更多的数据 IO 成本，因为每一级都会成倍增加行的大小。

考虑一个具有(A，B，C)列的索引，如果您看到统计数据，您会注意到有三种不同的行类型，`A`、`A,B`和`A,B,C`，并且行的大小也急剧增加。

对于非常大的表，超过三列的更新和搜索非常慢，因为大多数查询最终会搜索不同的页面。

# 包含多列的多栏

如果 SQL Server 建议您创建多于 3 列的索引，您可以将其他列放入包含部分，包含列不会增加大小，因为它们按原样存储，不会存储为索引列。如果查看查询计划，将在一个步骤中对包含列执行筛选，而不对聚集索引执行联接。

Sql server 仍然建议在所有列上创建索引，但是您会发现，包含的列越多，索引的列越少，更新索引和查询索引的平均成本就越低。

# 有多少列？

3 列并不理想，您必须针对高 CPU/数据成本查询运行您的测试，并找出最佳的列数。有些查询只需 2 个就能达到最佳性能，有些可能需要 4 个。

# 哪 3 列？

有限的值范围，如单个位(2 个值)、可空位(3 个值)、枚举列，如有限的(开/闭)集..任何字符串)可以被忽略，并可以放入包含的列中，原因是，对于索引列的任何组合，只有很少的几行要提取和测试。只有非常大范围的项目才应该放在索引列中。Rest 可以很容易地移动到索引列。同样，根据您的查询测试它，找出最佳组合。您必须了解存储在列中的值的种类，以便找到最佳组合。例如，如果 SQL Server 建议构建索引`A,B,C`和`C`是布尔类型(最多 2 种可能性)，如果`A,B`的组合只产生 1 - 20 行，您可以安全地忽略`C`。之所以安全，是因为 sql server 不需要跨越额外的页面，因为所有行都在一个页面上运行筛选。

# 索引存储

索引越小，更新就越容易，而且索引比实际的表使用更多的存储空间。Sql server 的`bacpac`格式不支持索引备份，所以经过测试，我发现对于 100GB 的数据库，`bacpac`的大小只有 3GB。

此外，索引碎片可能会增加数据库的总大小，在几乎无限存储的今天，我们不关心大小，但大小会影响许多其他操作。由于 CPU 的 RAM 有限，SSD 存储的大小也有限，减少索引大小将大大提高数据库的整体速度。

有必要重建碎片超过 30%的索引。