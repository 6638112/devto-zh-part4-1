# 使用 PowerShell 的 Azure 功能，我是如何开始的

> 原文：<https://dev.to/omiossec/azure-functions-powershell-6-weeks-after-4kf1>

自从预览版第一次开始，我就开始在 Azure Functions v2 中使用 PowerShell(差不多是 2019 年 4 月 30 日开始)。用 PowerShell 创建无服务器工具的想法非常令人兴奋。

什么是 Azure 函数？它是 Azure 上的功能即服务模型实现。它让开发人员只需关注代码就可以创建 API 和其他解决方案。可以看作是；你提供代码，Azure 提供并管理其他一切。

但是为什么使用 PowerShell Core 来创建 API，这不是最好的语言！你说到点子上了。PowerShell 不是 web 开发的首选语言。但是我有两个理由使用它。

第一个，就算我懂 Python 和。net，我对 PowerShell 更熟练了，我可以做很多用其他语言会花费我更多时间的事情。

第二，Azure Functions 不仅仅是 HTTP API，它是一个事件驱动的无服务器平台。由于 PowerShell 主要是一种操作语言(但你可以做 OOP，TDD，这是一种真正的语言)，用于自动化一切。Azure Functions 和 PowerShell Core 是基于事件的无服务器自动化工具。

在我的工作中，我必须管理 Azure 资源，根据不同的事件或条件停止和启动虚拟机，对资源发生的事情做出反应，移动东西，查询外部 API 等等

在我们谈论 Azure 功能之前，你必须了解 Azure 中的功能应用是什么:

功能应用程序只是一种 web 应用程序，简单到足以从门户、arm、cli(但不是从 PowerShell)部署，此应用程序可以包含一个或多个功能，您只需在功能运行时付费(使用免费层)。函数只是函数应用程序中的一个文件夹，带有一个 run.ps1 文件，其中包含函数代码和一个 function.json，用于函数绑定和触发器的配置。最后一件事，Azure Functions with PowerShell 加载了 AZ 模块来管理 Azure 资源。

在我使用 Azure 函数的第一天，我遇到了一些麻烦，但是除了一个问题之外，目前没有真正的问题；文件的缺乏。绑定上的每个输出操作都使用 push-OutputBinding。Blob、Queue、SignalR……使用相同的 cmdlet，但是您并不总是知道输出值的类型和/或格式。这与触发器的参数值几乎相同。

你要去测试，去尝试。我不得不看一下 c#的例子，它给出了你需要如何格式化值的线索。

注意，Azure 函数使用的是 PowerShell 核心，而不是 PowerShell 5.1 或其他 Windows PowerShell 版本。所以先更新你的开发平台。

我必须实现定时器功能，一个按时间表运行的功能。这很简单，你把你的代码，并给出一个 cron 表达式来调度执行。但是默认时区是 UTC，当您将函数配置为在 CET 时间下午 2 点运行时，它会在中午 12 点运行。但是可以在功能 app 层面更改。你需要添加一个应用设置，WEBSITE_TIME_ZONE。关于这个值，请看这个页面[https://docs . Microsoft . com/en-us/windows-hardware/manufacture/desktop/default-time-zones](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/default-time-zones)。是的，这个设置管理白天节省。

我更沮丧的是冷启动，特别是对于 blob 触发器。启动可能需要 5 分钟以上。调试时确实令人沮丧，但如果解决方案可以在启动前等待几分钟，并且您没有管理大量 blob，这不是一个大问题。如果不是，你应该看看事件网格。事实并非如此，所以我没有切换到事件网格。但是我测试过了，做起来并不复杂。

最大的特性之一是赋予函数一个身份的能力。这意味着你可以在订阅中给功能应用一个 Azure 广告系统账户。，系统分配的托管身份。它就像一个 Azure 广告用户或服务帐户。您可以通过 RBAC 向资源授予函数权限。如果您想要停止、启动或更改虚拟机，您可以使用带有身份的功能应用程序来完成这些操作。

这很好，但也很危险。函数从外部来源接收数据。默认情况下，数据应该被认为是不可信的。不管数据是来自触发器还是绑定，http 还是队列。在做任何事情之前，您应该测试数据类型和格式。

函数身份是一个伟大的特性，它让你自动化 Azure 比 Azure 自动化帐户有更多的能力和可能性。但是要避免给太多特权。仅将适当的权限授予适当的资源。不要为订阅或资源组提供参与者角色。

记住身份是给功能 App 而不是给单个功能的。在使用托管身份时，您应该考虑这一点。

使用 Azure Function 我学到的另一件事是避免编写一个可以做很多事情的长脚本。这有许多原因。第一个，很明显，Azure 函数使用无服务器模式，你也应该这样做。您还应该记住，默认超时是 5 分钟。您可以使用 function 应用程序根目录下 host.json 中的 functionTimeout 来管理从 1s 到 10 分钟的超时。

一个函数需要专用于一件事，就像 PowerShell(或者其他任何语言)中的函数一样。想象一下，你需要调用一个 Rest Api，将结果保存在 Azure Sql 数据库中，基于 Api 的结果启动一个 vm，并在 Azure 存储表中记录操作。

您可以在一个函数中完成此操作，但它可能无法很好地扩展，并且如果出现错误，您可能无法恢复操作，并且可能会丢失数据。

相反，您可以利用触发器和绑定来创建多个函数。

在这个例子中，我们可以创建一个函数来查询和解析 API 结果，然后在一个队列中添加一条消息，如果条件满足，它将在一个队列中添加另一条消息。我们现在可以创建两个队列函数，一个将管理数据库插入，另一个将启动 vm。对于日志操作，我们也可以使用队列触发函数。

使用队列，如果一个函数出错，消息将留在队列中，另一个运行将接管它。

使用几个函数使调试和测试更简单，编写代码也不那么复杂。

我学到的最后一件事是使用 PowerShell 模块。Azure functions 将加载 function App 文件夹根目录下的 modules 文件夹中的任何模块。

我没有为每个功能写脚本，而是开始为每个功能 App 创建一个模块。所有的业务逻辑都是模块，Azure 功能代码只调用我创建的 cmdlet。

我这样做是因为在一个模块中使用 pester 更容易自动化单元和验收测试。
另一个原因是代码重用。几个触发器经常使用相同的逻辑。您可以使用计时器触发器不时地运行一些业务逻辑，并使用 http 触发器按需运行。使用一个模块可以防止两次编写相同的代码。

带有 PowerShell 的 Azure functions 还在预览版，但我没有发现任何重大 bug。有时候，我不得不重启功能应用。最大的问题是文档。你需要学习和尝试很多。从运营的角度来看，Azure Functions 是一项重大变革。无服务器和松耦合模式对于 PowerShell 脚本编写人员来说是新的(对于不编写脚本的操作人员来说是另一个世界的东西)。但是学习它们是值得花时间去失败、发现和实验的。