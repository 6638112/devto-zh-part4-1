# 在 WordPress 测试我们的极限和耐心

> 原文:[https://dev . to/tedmasterweb/testing-our-limits-and-patience-in-WordPress-37ml](https://dev.to/tedmasterweb/testing-our-limits-and-patience-in-wordpress-37ml)

## [](#wordpress-integration-testing-overview-and-issues)WordPress 集成测试概述和问题

大约一年前，我开始尝试“官方的”WordPress 插件测试工具，同时开发我们的[approve 插件](https://wordpress.org/plugins/ratify)。我不是一个不怕惩罚的人，但我确实喜欢一个好的挑战，而且在很大程度上，我没有失望。

今年上半年，我们有了另一个使用测试框架的成熟机会。我们正在构建一个基于 WordPress 的定制出版解决方案。作为一个定制的解决方案，我们有一些插件可以让作者和编辑(更)容易地管理他们的内容，除了在他们的网站上跟踪你的每一次呼吸。作为一个几乎有 10 名开发人员的团队，我们都知道如何编写和运行测试是至关重要的。

我工作的很大一部分是开发人员培训。我决定创建一个练习插件，我们可以用它来训练开发人员如何使用框架和编写好的测试。该插件将允许你分配一个“国家”分类到任何标准或自定义的文章类型。我们写了一个插件的一般描述，然后一系列的测试，我们认为这将帮助我们做 TDD。从高处看风景总是更好。

## [](#coding-environment-and-tools)编码环境和工具

我们使用带有以下扩展的 vscode(实际上是更多，但这些与本项目相关):

*   【vscode 的 EditorConfig】
*   [Intelephense(PHP intellisense for Visual Studio 代码)](https://github.com/bmewburn/vscode-intelephense)
*   [Visual Studio 代码的 PHP 代码嗅探器](https://github.com/ikappas/vscode-phpcs)

虽然我是 BBEdit 的终身用户(偶尔也是贡献者)，但 vscode 中的某些特性让这种开发变得很有趣(编辑器中的 PHPCS 反馈、通过智能感知的代码完成、特别是多光标编辑)。请注意:我使用 [MarsEdit](https://www.red-sweater.com/marsedit/) 写这篇文章，只是因为它已经被配置为直接发布到我的博客。

## WP-CLI 和 Laravel Homestead

我们使用 [Laravel Homestead](https://laravel.com/docs/5.8/homestead) 做秘密来源的几乎所有事情。是的，我们知道，[码头工人是未来](https://circleci.com/blog/its-the-future/)，但我们喜欢家园。Homestead 可能需要一点调整才能和 WordPress 一起使用，但通常情况下它是可以工作的。

我们使用 wp-cli 来生成测试框架/工具(`wp scaffold plugin-tests`)。它工作得很好，但这是我们开始奋斗的地方，我将在这里详细介绍，因为 [Josh Pollock 想知道我们在与](https://twitter.com/Josh412/status/1162321172631080960)做什么斗争。

## [](#issues-with-the-testing-framework)测试框架的问题

总的来说，测试框架是有效的，我无法想象我自己要花费多少努力来重新创建它，所以，感谢 WordPress 团队制作了这个。也就是说，随着系统变得越来越复杂，在你的工具箱中有一个测试框架变得更加重要，所以，依我看，应该投入更多的努力使框架尽可能地易于使用。

### [](#installation-and-setup-seems-difficult)安装和设置似乎很困难

wp-cli 脚手架由几个文件组成，您将需要这些文件来获得测试框架的全部好处。它不包括您需要的实际工具或二进制文件。例如，为了使用这个框架，你需要 [phpunit](https://phpunit.de/manual/6.5/en/installation.html) ，不是任何版本，但是，根据我们的经验，任何高于 6.5 的版本都不能工作。还需要颠覆，所以，`sudo apt install subversion`。我不得不相信这两个步骤可以封装在 composer.json 文件中，但是它们没有，所以需要两个额外的手动步骤来配置您的环境。

### [](#initializing-the-database-issues)初始化数据库问题

当您安装测试框架时，它包括一个 bash 脚本(bin/install-wp-tests.sh ),该脚本试图设置整个环境，包括运行测试时使用的数据库。然而，这个剧本还可以改进。我不止一次发现自己不得不手动摆弄 MySQL(删除表格)并删除/tmp/wordpress 中所有对 WordPress 的引用，以便让脚本正常运行。此外，在脚本的结尾，有一个关于在命令行中包含密码的可怕的 MySQL 消息。它可以被忽略，但有解决方案来减少这种误导。

我会从尽可能地隔离依赖项开始，包括更多的健全性检查等等。因为这是用 bash 写的，我可以自己做，但是我感觉它应该是某种 PHP 脚本，甚至可以通过 composer 安装？

### [](#there-is-no-way-to-test-plugin-installation)没有办法测试插件的安装

据我所知…框架不允许你测试安装挂钩(安装好像在自举过程中被绕过了)。不幸的是，我们的练习插件有一个非常具体的要求，即在某些情况下不能继续，但是我们不能自动进行这个测试。

## (vs code 和)PHPCS 的问题

我不是 vscode 的忠实粉丝，但它确实有一些非常引人注目的特性，包括 PHP 代码嗅探器扩展，它可以帮助您编写格式正确的代码，并且代码在理论上不太复杂。这是我真正想要的功能，因为我需要我能得到的所有帮助！

实际上有两个问题:

1.  WordPress 插件测试框架与 WordPress 核心相比有一套不同的代码嗅探(不确定它们被称为什么),这是合理的，但是如果你一般不知道如何 phpcs，这将需要相当多的调查才能弄清楚，就像我们的例子一样。
2.  vscode phpcs 扩展有一个针对每个项目的安装选项(如果你不介意通过 npm 安装 phpcs 的话),但是让 vscode 找到二进制文件可能很棘手，然后配置 phpcs 查看正确的嗅探可能更难。我们设法让它设置好并开始工作，但是如果你想学习如何做，我建议你看看 wprig.io github repo 中如何做的例子。

## [](#difficulty-defining-tests)定义测试难度

为 TDD 编写好的测试是一门艺术，简单明了。如果你找到一个真正擅长这个的人，紧紧抓住她，不要放手。尽可能多地向她学习，如果你是她的上司，给她练习艺术所需的自由(和时间)

我们为实践项目编写的第一个测试结果是使用 WordPress 测试框架不可测试的。出于好奇，如果一个名为“国家”的分类已经存在，我们希望插件不能正常安装。由于调用测试工具的方式，插件跳过了正常的安装过程，这是我们计划测试所述分类存在的时候。我不会详细说明我们花了多少时间来解决这个问题，但我会说这不是无关紧要的，围绕这个主题的文档很少。我们刚刚读了引导代码。

第二个测试对环境将包含什么、环境中将有什么数据做了一些假设。这很好，但这意味着我们必须在运行测试之前进行大量的模拟，甚至创建数据，以便能够进行测试。只要测试时间相对较短，这不是一个大问题。在我看来，应该有一种更直接、更快速的方法来测试这方面，但我还没有找到。

## [](#the-future)未来

多亏了其他积极的 WordPress 用户，WordPress 和测试的未来看起来还是很光明的。我的计划是在接下来的几周内解决这个问题。我最终会发布我们的样本插件，所以[如果你有兴趣看到最终结果，请在 Twitter 上关注我](https://twitter.com/tedmasterweb)。

WordPress 上的[测试我们的极限和耐心的帖子最先出现在](https://www.chicagoitsystems.com/testing-our-limits-and-patience-in-wordpress/)[芝加哥 IT 系统有限公司](https://www.chicagoitsystems.com)上。