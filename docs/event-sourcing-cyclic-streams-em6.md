# 事件来源-循环流

> 原文：<https://dev.to/kspeakman/event-sourcing-cyclic-streams-em6>

在开发新产品的过程中，我有了一个新的发现——循环流。这实际上不是一个新概念，但我以前从未遇到过这种模式。我想为你们中做活动采购的两三个人快速描述一下。😀循环流是我创造的一个术语。如果对此有预先存在的术语，请告诉我。

## 问题

一些工作流程是循环的:每月审计，或每年培训。在过去，我把每一个都表示为它自己的事件流。有一个定义的开始和结束事件，以及其间的少量事件。这很方便，因为我从来没有遇到过流回放很慢的情况。这样我就不必引入额外的架构复杂性，比如快照(我仍然不需要它)。

这种方法有局限性。有可能为同一时间段创建重复的流。例如，一个副本可能是通过用户操作创建的，而另一个副本可能是由后端进程同时创建的。最终结果是一个学生两次报名参加同一个培训。这并没有那么糟糕，因为在 UI 中很容易注意到。但是当用户界面不自然地显示重复项时，情况会变得更糟，审计可能就是这种情况。以前的产品使用事件和视图存储之间的完全一致性。视图上的唯一索引捕获了竞争条件。但是我们的最新产品使用最终一致的视图，所以我必须决定如何处理这种情况。

Greg Young 有一篇关于集合验证的文章，主要是鼓励读者不要太担心防止重复，而是关注检测和纠正。因为这在生产中不太可能真的发生。我大体上同意这个建议。然而，它仍然需要我编写额外的工具来检测和纠正。需要注意和维护的东西更多，即使这比预防选项要少。我能设法不用额外的代码解决这个问题吗？

## 反思溪流

我开始想，我是否可以对一个工作流的所有迭代使用相同的流，而不是每年制作一个新的。例如，特定学员和课程的培训事件总是进入同一个培训流。我可以使用确定性 UUID 从学生和课程 ID 中计算出一致的 ID。`Uuid.deterministic(StudentId + CourseId)`。这就相当于把每年所有的单个溪流合并成一条大溪流。

这可以防止重复，但现在我又需要快照了。只会变得更糟。培训过程可能会随着时间的推移而改变。(在我们之前的产品中已经有了。)所以摄影师必须知道如何处理训练过程中所有先前化身的特性！呃。我们所需要的只是流末端的当前事件。

坚持住...我能读一下流的结尾吗？我记得在玩 [EventStore](https://eventstore.org) 时，它有一种向后读取流的方法。我一直想知道这能用来做什么，但现在开始有意义了。我可以向后读取流，直到遇到一个标记事件，比如最后一次训练的最终结果:`TrainingCompleted`(或者`Canceled`或者其他什么)。我想这就够了！

总而言之，这种模式的要素如下。

*   一个循环的过程，如每年一次的训练
*   基于相关实体 ID 的一致 ID
    *   当心使用“自然键”，它可能会改变
*   向后读取流，直到一个标记事件，以获取“当前”事件

这巧妙地避免了创建重复流的可能性。它也不需要额外的建筑构件。不用写的代码(尤其是架构上的)是我的最爱。

/∞