# 如果我在您的 Redis 实例上调用 FLUSHALL 会怎么样？😱

> 原文:[https://dev . to/honey badger/what-if-I-called-flush all-on-your-redis-instance-2g C1](https://dev.to/honeybadger/what-if-i-called-flushall-on-your-redis-instance-2gc1)

在[蜜獾](https://www.honeybadger.io)，我们大量使用 Redis**。这是我们的瑞士军刀；这是一个缓存，一个真实的单一来源，它存储后台作业，等等。基本上， **Redis 是那些永远不会失败的服务之一。****

 **我最近在思考 DevOps 启示录，就像一个人做的那样(Redis 可能是四骑士之一吗？)，这让我跳进我们的 *#ops* 频道，问本一个简单的问题:

> **josh [13:58]**
> 
> 如果有人在我们的 redis 实例上执行 flushall，会有什么风险？
> 
> **本【13:58】**
> T3】你刚才的话让我微感心脏病
> 
> **乔希【13:59】**
> 
> 罗夫
> 
> 对不起:)
> 
> 我没有做，郑重声明
> 
> **本【14:00】**
> T3】各种各样的坏事都会发生...作业队列会被刷新，可能会出现重复通知，时间表会开始点击 es 而不是被缓存，等等:)
> 
> 这将是非常糟糕的一天:)

别担心，本几个小时后就恢复了，基本上又恢复了原样。我应该开始我的问题；我并不是说我真的清空了我们的 Redis 集群。不过，这也证明了我的观点。也许摸摸你的汗腺，量量他们的汗水是为灾难做准备的好方法...

### [](#so-id-identified-a-potential-issue-it-would-be-really-bad-if-redis-got-flushed-what-are-the-risks-of-that-happening)如此。我发现了一个潜在的问题。如果 Redis 被冲走了那就太糟糕了。发生这种情况的风险有多大？

我们的 Redis 集群部署有主实例和辅助实例，跨越 AWS 中的多个可用性区域，并在主实例出现故障时自动故障转移到辅助实例。这是一个非常可靠的 Redis 部署；我们可以丢失整个实例，而不会丢失数据，甚至不会影响其他服务。

不幸的是，防止人为错误要困难得多，出于某种原因，Redis 使得通过在错误的控制台中输入一个命令来删除所有数据变得非常简单。我们的建筑没有防范这一点。虽然我们的团队意识到了这一点，但是未来的开发人员很有可能会犯这个错误。

### [](#in-fact-my-friend-molly-struve-sr-sre-at-kenna-security-remembers-a-situation-where-something-similar-happened)事实上，我的朋友莫莉·斯特鲁维，在 [的老 SRE，肯纳保安](https://www.kennasecurity.com/) 记得有一次发生了类似的事情:

> 我们对一些代码进行了更改，导致 Redis 中的旧缓存值与新代码断开。所以我们会请求旧的值，而这并不是代码所期望的。我们的一名工程师认为，与其回滚代码，不如运行`Rails.cache.data.flushdb`并从一个新的缓存开始。

像 Honeybadger 一样，Kenna 在几个方面使用 Redis 一个是他们的 Ruby on Rails 应用程序的缓存后端。Molly 提到的命令`Rails.cache.data.flushdb`，是 Ruby on Rails 相当于打开一个 Redis 控制台并调用`FLUSHDB`(删除当前数据库中的所有数据)。

不幸的是，Redis 还被用来缓存来自 Elasticsearch 的报告数据(顺便提一下，我们在 Honeybadger 也这么做)，这就是问题所在。Redis 数据库刷新后，缓存必须从头开始重建，这让他们的 Elasticsearch 集群不堪重负:

> 我们有一个“仪表板”页面，客户可以在那里加载他们所有报告的一部分(想想几百个)，当客户开始在没有缓存的情况下点击这个页面时，Elasticsearch 就像圣诞树一样亮了起来。所有节点上的 CPU 都达到了极限。最后，打开多个控制台重新缓存报告是一种疯狂的争夺。

Kenna 的系统恢复后，Molly 与开发团队合作，确定他们可以采取的措施，以防止将来发生同样的事情。他们为可能没有意识到清除 Rails 缓存是一种破坏性行为的新开发人员提供了一种创造性的保护措施:[他们将所有生产应用程序控制台默认设置为只读](https://gist.github.com/mstruve/fe7ec87e7b76d228146b9a5a33c79bf3)。

幸运的是，Kenna 的事故并不是灾难性的——他们在短暂的停机后就恢复了。如果不幸的开发人员不小心调用了`FLUSHALL`——这会刷新**所有** Redis 数据库——而不是`FLUSHDB`,情况会更糟。在压力下这是一个容易犯的错误，尤其是当异常报告已经滚滚而来的时候(我有没有提到他们也使用蜜獾？)

### [](#let-me-ask-you-a-quick-question-what-would-happen-if-someone-called-raw-flushall-endraw-on-your-redis-console)让我问你一个小问题:如果有人在*你的* Redis 控制台上呼叫`FLUSHALL`，会发生什么？

如果答案是“一切都会失控”，那么你可能会考虑采取预防措施。这是我们所用的。当然，这是我们(我有点多疑)——你的里程数可能会有所不同。

首先，通过*客户端*(即在 Rails 控制台中)访问 Redis 应该完全禁止使用`FLUSHALL`和`FLUSHDB`命令。开发人员*从来不需要在生产中运行这些命令；这样做会导致严重的问题，那为什么还要有这些问题呢？*

如果你是 Ruby/Rails 用户，请随意[窃取这个要点](https://gist.github.com/joshuap/c1ff2657c150df6fb1257398b1d2716b)。如果你想要更全面的东西，[见莫莉的要点](https://gist.github.com/mstruve/fe7ec87e7b76d228146b9a5a33c79bf3)。如果你使用不同的编程语言，*希望*有办法禁用这些命令，但即使没有，别担心，我有办法。

## [](#the-redis-config-that-everyone-should-use)每个人都应该使用的 Redis 配置

Mike Perham 是 Sidekiq(目前最流行的 Ruby 后台作业系统，拥有 T2 令人敬畏的商业模式)的创始人，他对 Redis 略知一二。Sidekiq 构建在 Redis 之上，提供了一个非常可靠和高效的作业系统。

我问 Mike，他向他的客户推荐了哪些最佳实践，他们中的许多人都部署了任务关键型 Redis(想想网飞和甲骨文)。他告诉我，担心 Redis 数据安全的用户应该通过 Redis 的配置文件完全禁用破坏性命令。

这种方法有一个额外的好处，即命令在任何地方都是禁用的，包括在`redis-cli`控制台中。应将以下配置添加到`redis.conf`:

```
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command CONFIG ""
rename-command SWAPDB "" 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

将上述命令重命名为空字符串意味着它们将不再作为 Redis 命令存在。如果您仍然希望能够在罕见的(有意的)情况下调用它们，您可以将它们重命名为秘密名称:

```
rename-command FLUSHALL SUDO_FLUSHALL_222ed15a
rename-command FLUSHDB SUDO_FLUSHDB_2a3bdd5e 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

例如，您可以将这些命令放在只有您的操作团队可以访问的末日行动手册中。像对待你们公司的核代码一样对待它们。

### [](#of-course-theres-always-a-caveat)当然，总有一个警告🤦

我们使用亚马逊的 elastic cache 服务来托管我们的 Redis 集群，经过一些研究，我了解到 elastic cache 并不提供对`redis.conf`的直接访问，它也没有为`rename-command`提供一个 [Redis 配置参数](https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/ParameterGroups.Redis.html)。所以不幸的是，虽然我们的应用程序控制台是安全的，但我们仍然必须小心处理`redis-cli`。

最后，我们在我们的内部 Redis 剧本中添加了一个关于这一点的注释，并将偶尔重新查看 ElastiCache 文档，看看亚马逊是否允许我们访问`rename-command`。

## [](#failures-are-inevitable)失败是必然的

如果有可能在失败发生前 100%预防失败，我们的工作就会容易得多。我们不需要随叫随到的轮换或事后检查，我们都可以全职编码。不幸的是，我们生活在现实世界中，混沌统治，熵确保我们的系统不断恶化。

我们做的每件事都有内在的风险。为了发布稳定的应用程序，我们应该采取措施来最小化风险。这样做，我们减少(但不是消除)了失败的可能性。

### 作为一名开发人员，能够评估与您的行为相关的风险极大地增加了您的价值。

莫莉和其他人的故事让我相信同样的事情很容易发生在我们身上；(感知的)风险很高。解决方案——禁用潜在的破坏性命令，或者使它们极难执行——相对容易。

高价值和最小努力的结合有一个名字:低挂水果。在软件的上下文中，它是这样的想法:如果你能通过做一个小的改变而获得很多，那么它可能是值得做的。这感觉就像是在用少量的努力消除大风险的甜蜜点上。有点像我第一次安装[蜜獾](https://www.honeybadger.io)...；)

* * *

这个故事改编自我最近发给我们社区时事通讯《升级》的一封电子邮件。如果你喜欢它，请随意订阅。T3】**