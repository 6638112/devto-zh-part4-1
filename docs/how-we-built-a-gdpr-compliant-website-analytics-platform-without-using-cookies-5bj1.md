# 我们如何在不使用 cookies 的情况下构建符合 GDPR 标准的网站分析平台

> 原文：<https://dev.to/jackellis/how-we-built-a-gdpr-compliant-website-analytics-platform-without-using-cookies-5bj1>

经营一家注重隐私的企业意味着我们总是在寻找方法提高用户隐私，同时提供有用的软件。为了进一步实现这一目标，我们最近做了一些改变。我们的目标是在不影响访问者体验的前提下，继续为用户提供独特的访问量和总浏览量。没有人希望他们的网站上出现那些烦人的弹出窗口，除非他们不得不这样做。

因此，让我们深入了解一下我们是如何以注重隐私的方式构建这一平台的:

# 第一个想法:针对每个用户的复杂哈希

我们的第一个尝试是为访问者创建一个复杂的、唯一的散列，并将该散列与他们在我们的数据库中的每个页面视图联系起来。这样做意味着我们可以更新他们以前的页面视图，确定页面视图/网站访问是否是唯一的，产生一个持续时间，并在我们的代码库中做很少的改变。

我们放入散列的数据将包括:

1.  随机 SHA256 字符串(每天午夜 UTC 重新生成)
2.  IP 地址；网络地址
3.  用户代理人
4.  站点 ID
5.  一年中的某一天

因此，初始数据可能看起来像这样:

`5c5fe02e320dd2af45a29d8cdf5c99ef947edea2c067cea501ee695bb46a2652 + 198.199.80.4 + Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36 + ABCDEF + 250`

这将被散列为:

`93bcc1b5fa0841f641b4d5173d1393a267fa153ec49a13bacffebd7cf9905f4a`

但是这样做意味着我们可以看到用户当天在某个网站上访问的每一个页面…这绝对是一场灾难。虽然它是匿名的，但我们仍然会为用户建立一个完整的浏览历史，这将允许“挑出”，这是我们永远不想要的。

# 第二个想法&解决方案:我们保存多个不相关的复杂散列

请记住，Fathom Analytics 需要完成的事情之一是能够跟踪网站和个人页面的访问量。仅仅跟踪页面浏览量，而没有访问量，是完全没有用的，这意味着你无法洞察每天有多少人访问你的网站/页面。我们可以做得更好，方法如下:

1.  **用于跟踪独特的页面浏览量:**对于每个请求，我们生成一个类似于我们在文章前面讨论过的散列，但是我们在。我们称这种杂凑为`PageRequestSignature`。然后，我们将这个`PageRequestSignature`与今天的签名哈希表进行核对。如果它存在，当前请求被标记为“非唯一的”,但是如果它不存在，我们插入它并将当前请求标记为“唯一的”
2.  **用于跟踪独特的站点视图:**对于每个请求，我们生成一个类似于`PageRequestSignature`的散列，除了我们不包括`Hostname`和`Pathname`，因为我们跟踪的是访问者是否是该站点而不是特定页面的新访问者，我们添加一个新的数组项以确保它不同于下面详述的签名
3.  **用于跟踪以前的请求**(并将它们标记为完成，而不是退回和请求之间的持续时间):这是最具挑战性的一点，因为我们需要将用户以前的页面视图与它们联系起来，而不保留它们的页面视图历史。为了实现这一点，我们清除了 pageviews 表中前一个视图的`UserSignature`值(这是我们第一个想法的散列值),为新条目(保留了`UserSignature`)让路。这意味着，在任何时候，我们每个用户签名只有 1 次浏览量。这意味着我们不能把匿名的个人用户的浏览习惯放在一起。请记住，用户签名是完全匿名的，不，只有一个页面视图绑定到它

我们生成的散列对我们来说是不可能“去散列”的(我们将在本文后面解释)。需要注意的是，哈希不同于加密。通过加密，您可以解密，而哈希是单向的。

页面浏览量也会被处理&一旦被认为完成(在 30 分钟内或当用户访问了另一个页面时)，就会从我们的临时表中删除。此外，我们每天午夜回收我们的 SHA256 盐串。这不是必须的，但是它增加了未来计算能力和彩虹表的复杂性。

此外，在将数据放入 Redis 队列之前，我们在收集端点上执行所有这些散列。这样做的原因是因为 Redis 是一个数据存储，我们不想存储明文 IP 地址、用户代理等。在那里。

要解决的最后一个问题是，我们是否可以获取一个用户签名(例如`f2d9be5d11064121fd5ec822be4a0453ba01bc303fe6f9c1d7c4f10e52655ae1`)并搜索我们的查询日志，以找到该匿名用户在网站上的每个页面视图。好消息是，我们在这方面是安全的，因为我们只在查询日志中记录数据定义语句(例如，创建、更改和删除)，而不是插入/更新等。

# 匿名化

哈希的目的是确保我们没有现实的方法来从我们跟踪的数据中识别个人——这是 Fathom Analytics 真正“以隐私为中心”的最重要的一点，坦率地说，这使我们在网站分析领域脱颖而出。这对 GDPR 合规性/免除 GDPR 也很重要。

以下是 GDPR 第 26 场独奏会的要点和我们的评论:

| 回顾 26 | **我们的评论** |
| --- | --- |
| 为了确定一个自然人是否可以识别，应考虑到所有合理可能使用的手段，例如由主计长或另一个人挑选出来直接或间接识别该自然人。 | 自然人/匿名用户不能被挑选出来，因为一切都被散列。唯一可以连接的部分是当我们更新用户以前的页面视图时，但这都是在单个数据库事务中完成的，我们不保留查询日志。 |
| 为了确定是否有合理的可能使用手段来识别自然人，应考虑到所有客观因素，如识别所需的费用和时间，同时考虑到处理时可用的技术和技术发展。 | 强行产生一个 256 位的散列值将花费 10^44 世界生产总值(GWP)的两倍。2019 年 GWP 是 88.08 万亿美元(880.8 亿美元)，所以我们至少差几美元就能强行产生一个 256 位的哈希。 |
| 因此，数据保护原则不应适用于匿名信息，即与已确定身份或可确定身份的自然人无关的信息，或以数据主体不可确定或不再可确定的方式匿名的个人数据。 | 我们对数据进行了匿名处理，以至于我们无法从散列中识别出自然人。 |
| 因此，该条例不涉及此类匿名信息的处理，包括出于统计或研究目的的处理。 | 有可能 GDPR 不适用于 Fathom，因为数据是完全匿名的。即使 GDPR 仍然申请，我们重申的立场是，有合法的商业利益来了解你的网站是如何表现的。 |

# 关闭思绪

还有其他的分析平台已经没有 cookie 了，但是他们不提供用户的总访问量，只有浏览量。任何需要网站分析来从他们的在线业务中赚钱的人都可以告诉你为什么总访问量是如此重要的指标，也是我们通过 Fathom 分析软件在注重隐私的领域中努力实现的指标。

值得注意的是，这些变化仅适用于我们的托管版本，并且这些变化将在今年晚些时候我们开源新代码库时到达 T2 社区版。).

我们对任何想法、评论或担忧都非常开放。这是我们的一大进步，但总有改进的空间。

2019 年 7 月 21 日发布。由[杰克·埃利斯](https://twitter.com/jackellis)和[保罗·贾维斯](https://twitter.com/pjrvs)撰写。