# 了解和优化 Azure Cosmos DB 中的吞吐量

> 原文:[https://dev . to/will velida/understanding-and-optimizing-throughput-in-azure-cosmos-d b-5a Pb](https://dev.to/willvelida/understanding-and-optimizing-throughput-in-azure-cosmos-db-5apb)

[![](../Images/3e22cf2cac950580e66d37ff65491971.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--H2P89wVm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/650/0%2AXlYpzKXzSV61ltFV.jpg)

当我们对我们的 Cosmos 数据库进行操作时，我们使用一种叫做请求单元(RU)的东西，这就是你用来衡量吞吐量的东西。如果你要写一篇文章给 Cosmos，你要花 RU 的。如果你读了宇宙中的一个项目，你就花了 RU 的。如果你在 Cosmos 中进行查询，你就会明白。这是一致的，不管你的 Cosmos 账户使用什么 API。

当我们供应我们的容器和数据库时，我们设置我们想要为容量保留的 RU 的数量。这必须足以确保我们在宇宙中的资源随时可用。但是我们如何确保我们的 Cosmos DB 有足够的 RU 呢？我们是否只是每次增加 RU 的数量，随着数据的增长花费越来越多的钱？或者有没有更有效的策略来确保我们的应用程序在 RU 支出方面不会像下雨一样？

嗯，这就是这篇文章的目的！我在这里尝试做的是解释吞吐量在 Cosmos DB 中是如何工作的，以及如何优化 Cosmos DB 解决方案的设计，以帮助您减少应用程序用来防止节流的请求单元的数量。

对于本文，我将使用。针对使用核心 API (SQL)的 Cosmos DB 帐户的. NET 代码示例。

以下是对 RU 的高度概括:

[![](../Images/07b72bb7c0c67bd08d13caaa032c9a2b.png)T2】](https://res.cloudinary.com/practicaldev/image/fetch/s--7BR_sZ1_--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1000/0%2AJP4pmCyKk-UQ9w0k.png)

请求单位是我们用来对我们的 Cosmos DB 数据库进行操作的货币。它是基于速率的，考虑了内存、cpu 使用和输入/输出操作。无论你为你的 Cosmos 账户使用什么 API，费用都是用 RUs 来衡量的。

当我们调配 RU 时，我们以每秒 100 个 RU 的增量进行调配。我们可以随时以 100 个 RUs 的增量或减量进行扩展。这可以通过编程(imo，cool way)或使用门户来实现。我们可以在数据库级别或容器级别提供吞吐量。

假设我们以每秒 400 个 RU 的速度供应一个容器。我们可以每秒进行 10 次查询，花费 40 个 RU。超过这个范围，我们将开始经历一些节流，我们应该着眼于规模。

在我们介绍如何在这两个级别上调配吞吐量以及为什么要这样做之前，我们先讨论一下在估计需要调配的 RU 数量时需要牢记的一些因素:

*项目大小和项目属性计数*

记住你的物品有多大是个好主意。当一个项目的大小增加时，读写该项目的 RU 的数量也会增加。一个项目有多少个属性也是如此。随着我们资产的增加，RU 成本也会增加。

*对项目和属性进行索引*

默认情况下，每个项目都有索引。此外，默认情况下，项目中的每个属性都被索引。这允许对任何属性进行快速查询，但是当涉及到 RU 支出时可能会很昂贵。如果我们想为 Cosmos 操作节省 RU 成本，我们可以通过定义自己的索引策略来限制索引属性的数量。

定义我们自己的索引策略相当简单。我们可以设置索引模式，并排除和包含要索引的属性路径。

在 Cosmos DB 中，有两种索引模式:

1.  **一致**:这里，索引随着我们在 Cosmos 中创建、更新或删除项目而同步更新。我们在 Cosmos 帐户上设置的一致性级别将是我们对 Cosmos 帐户的读取查询的一致性。
2.  **None** :这意味着索引几乎被禁用了。这有助于提高批量插入的速度。

我们可以通过决定要包含或排除哪些属性路径来实现自定义索引。这可以帮助我们降低容器使用的存储量，并改进我们的写操作。

为了让您快速了解 Cosmos DB 中的索引是如何工作的，每个项目都被投影为一个 JSON 文档，然后被转换为类似树的格式。项目的每个属性都被表示为树中的一个节点。根节点将被创建为该项目的所有一级属性的父节点，然后叶节点将包含该项中携带的标量值。

用一个例子来讨论这个问题可能是个好主意:

假设我有一个带有任务集合的 Cosmos DB。任务集合中的项具有以下架构: