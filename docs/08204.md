# 做 CRUD:地形风格

> 原文:[https://dev.to/jpninanjohn/doing-crud-terraform-style-l3n](https://dev.to/jpninanjohn/doing-crud-terraform-style-l3n)

**面纱**

我第一次使用`terraform`是在 openstack 云上创建虚拟机。

这看起来很简单，我们所要做的就是用给定的一组参数调用一个命令，它就会发挥它的魔力，按照我们想要的那样吐出虚拟机。T3】

它可以做得更进一步:维护所创建的一个或多个虚拟机的状态，并在任何被跟踪的状态字段发生变化时向我们显示。看起来很简单，我们所要做的就是用给定的一组参数调用一个命令，然后它就会施展魔法，按照我们想要的那样吐出虚拟机

最初，我总是将 terraform 对基础架构的作用联系起来，例如创建虚拟机、设置网络、卷…以及其他与基础架构相关的活动。我看不到通过这个面纱，我自己创造了这个工具。

**火花**

在我后来的一个项目中，我的团队遇到了一个非常老套的问题陈述。客户有一个部署平台。姑且称之为‘A’吧。虽然它曾被大量用于将许多应用程序部署到他们的生产系统中，但现在它已被弃用，取而代之的是另一个构建的平台。现在，我们必须将以前的平台“A”部署的所有应用程序移植到我们称之为“B”的新平台上。

应用程序的数量绝对不小，我们必须记住，新平台将要求处理应用程序的各个团队也改变他们的部署策略。

这是一个非常普遍的问题陈述，我们很多人以前都遇到过。只是这一次，我们决定尝试新的东西，而不是用传统的、过时的方式。我提到团队必须改变他们的部署策略，所以我们必须跟踪哪些应用程序迁移到了新的平台，哪些没有。所以我们需要状态，因此我们决定使用 terraform 的内置机制来处理我们用例的状态。

我们需要状态，因此我们决定使用 terraform 的内置机制来处理我们用例的状态。T3】

就这样，我们开始了尝试使用 terraform 将应用程序从一个平台迁移到另一个平台的旅程。作为第一步，将建立一个新的平台提供商。在不确定是否可行的情况下，我们开始着手进行。每个人都有这样的想法——“我们是不是在用一个工具做一些不该做的事情？”

最初的恐惧很快被意识到是我们在工具上制造了这个障碍所取代。每个资源的实现本身表明它使用了 4 个函数——创建、读取、更新和删除。这意味着任何做这些操作的东西。terraform 可以使用和做同样的事情。

***做这些操作的任何东西；terraform 可以使用和做同样的事情。*T3】**

**编写自定义提供程序**

我将从较高的层面进行解释，而不会过多涉及这需要什么技术细节。

什么是提供商？提供商代表着为我们服务的平台。terraform 中的每个提供者都需要一些字段。这些字段通常是提供者的配置，如联系提供者所需的内容。例如

```
provider "aws" {
  region                  = "some-region"
  shared_credentials_file = "creds required"
  profile                 = "profile name"
} 
```

这些是 AWS 提供程序所必需的。类似地，其他提供商将采用其适当的配置。对我们来说很简单——只要新平台所在的 IP 地址，因为那是我们的提供商。

一个提供商可以拥有许多资源。提供者的配置在所有资源之间共享。

什么是资源？。资源是提供者可以创建或提供的东西。例如，在 AWS 中，

```
resource "aws_instance" "web" {
  ami = "ami-id"
  instance_type = "t1.micro"
 } 
```

对我们来说，资源就是“B”上的应用程序。每个资源也需要一些字段。

***Create*** 函数获取资源的字段，创建一个 JSON 主体并将其发送给‘B’。这样做的配置是通过提供者共享的。*它还在状态文件中存储资源字段。*

`The Create function makes a POST call to create the application`

***Read*** 函数使用通过提供者共享的配置从‘B’读取，并相应地改变状态文件。*这将刷新状态，并检查平台上是否有任何变化，以达到我们 terraform 文件中的期望状态。*

`The Read function makes a GET call to read the application`

***更新*** 函数将改变后的资源作为 JSON 体发送给‘B’，*更新状态文件。*

`The Update function makes a PUT call to update the application`

我们不需要删除功能，因为我们只是在迁移。

但是现在我想你们应该都明白我的意思了。

在这一切之下，terraform 的神奇之处只不过是 CRUD 操作。T3】

***可能性***

在这个启示之后，我们都有很多关于如何使用 terraform 的想法。有很多想法，比如为 zsh、bash、shell 设置、机器设置建立一个提供者…

任何进行 CRUD 操作的东西都是开放的。 ***构建一个定制的提供者来实现操作，您就可以开始了。*T3】**

我将写另一个关于构建定制提供者的主题，包含更多的技术细节。小心点。

我们也开始寻找其他人是否已经偶然发现了这一点。我们遇到了一些非常疯狂的事情。就像这个——[https://github.com/ndmckinley/terraform-provider-dominos](https://github.com/ndmckinley/terraform-provider-dominos)。订购比萨饼的平台提供商。LOL。

这表明，对于外面的许多事物，是我们自己挡住了我们的视野。

好吧，我希望你们都喜欢这本书。我只是想分享我对工具的一些想法，事实上我对它很天真。

也许这也为在那里阅读的人激发了一些新的想法。

也许这将消除面纱，如果它存在于一些人身上的话。

感谢阅读。如果你愿意分享，请发表你的想法。也欢迎对内容的任何反馈。