# 我如何写微服务(第一部分)

> 原文：<https://dev.to/zenithar/how-i-write-micro-service-part-1-8ie>

在我的软件开发经验中，作为一名代码评审员，我看到了许多不好的实践，并收集了许多尝试构建更好产品的技巧。我想专注于一个特定的部分，以便准备一个增强的 Golang 项目模板，融合所有这些技巧和实践。

# (再)什么是微服务？

## 我自己的个人定义

> 微服务是一个内部自治的、可观察的、不可变的、可伸缩的、自包含的非整体式架构部署单元。每个微服务部分或完全负责业务问题的一部分，由服务网关编排和公开。

微服务并不意味着微“代码”基础设施，因为如果你把微服务想成微码，你将处于一个`pico-service`的世界，其中每个服务被设计成运行大约一个汇编操作码。当我写道:“哦，伙计，这是一个好主意，我们可以有一个分布式的多架构组装服务，可以在 Kubernetes 上运行”时，我听到了技术早期采纳者的声音。

> 一个`opcode`是由你的 CPU 执行的指令

将微服务视为`deployment unit`，构建并运行它是为了实现更复杂的服务。出于部署的原因(繁重的负载，有时是可重用性)，责任已经被分担。所以不要设计没有`a full vision of your business service`的微服务。我并不是说将你的代码回滚到那个华丽的庞然大物，而是考虑将它拆分成微服务应该是`driven by technical requirements`(负载平衡，等等)。)，而不仅仅是为了花哨的炒作原因。

> 微服务加问题间网络！

而所有的微服务都是`micro-service style architecture`的一部分，服务于一个确定要到达的目标。

将它们分开并通过外部传输与它们联系，只需将外部传输问题添加到您试图解决的业务问题中(连接弹性/爆炸、分布式并发等)。)

> 还是那句话，在怎么做之前一定要知道要做什么！

# 建筑图案

> 干净的代码不是按照一套规则编写的。通过学习一系列启发法，你不会成为一名软件工匠。专业和工艺来自于推动学科发展的价值观。 **罗伯特·c·马丁，干净的代码:敏捷软件工艺手册**

架构模式是一个框架，在这个框架中，你必须理解所有的概念，但是只使用你需要的。

在软件开发中，架构不应该是首先要解决的最“热”的点，你应该专注于特性来为你的产品增加价值。以至于为了节省时间，许多架构模式的存在是为了能够思考“我想做什么”，而不是“我要如何组织我的代码”。

> 这是软件架构师的主要任务，在添加特性和及时保持代码可维护性之间进行平衡。

## 干净的建筑

“鲍勃叔叔”清洁架构是一个架构工具箱，用来描述和组织软件组件概念以及它们之间的通信方式。

这种架构模式的主要目标是设计耦合性非常低的软件，独立于技术实现，并且完全可测试。

*   `Entities`，不包含业务逻辑只包含内在验证；
*   `Use Cases`，包含完全独立于技术实现的业务逻辑；
*   `Interface Adapters`，包含通过呈现者(HTTP，gRPC，Subscriber)与用户案例之间的外部世界的桥梁；
*   `Frameworks & Drivers`，包含所有技术实现(数据库、安全控制等)。)

所有层都受 [**依赖规则**](https://en.wikipedia.org/wiki/SOLID) 的约束。依赖规则告诉我们，内层不应该依赖外层。也就是说，我们的业务逻辑和应用程序逻辑不应该与表示器、UI、数据库或其他元素挂钩。外层的东西都不能被内层的代码提及。

## 六角形建筑

> 允许应用程序同样由用户、程序、自动化测试或批处理脚本驱动，并独立于其最终运行时设备和数据库进行开发和测试。

该架构的主要目标是使用`ports and adapters`将业务服务和规则从技术环境中隔离出来。

当你开始一个项目时，你必须做出技术上的选择，这个选择最终会暴露出是一个糟糕的选择(项目终止，许可证变更等等)。)，当没有将这些实现从您代码中分离出来时，您将无法快速切换到新的实现。

例如，您希望使用功能作为服务模式来构建软件，但您坚持使用 AWS Lambda 调用，在内部使用 AWS 服务对象，当您希望迁移到 GCP 或其他地方时，您的代码将完全紧密地耦合到 AWS，而不是定义技术上独立的业务逻辑并提供 AWS Lambda 适配器。

通过将业务从技术依赖中分离出来，您可以使用 mock 和 stub 进行测试。你也可以开始你的项目，而不需要等待所有部分的完成，只需要合同(适配器)。您还可以在不部署整个堆栈的情况下开始测试您的代码，不需要等待最终的工件可用和构建。您可以一层一层地测试每个特性。

通过将您的项目从基础设施中分离出来，您可以拥有一个快速的演示产品；通过更改适配器，您可以在 docker 容器中将您的产品作为简单的 HTTP 服务器运行，然后作为生产目标在 AWS 上部署为 Lambda。不要以为用 AWS 测试你的代码，作为单元测试级别是强制的，即使作为集成级别，你也不必测试 AWS Lamda 调用，而是测试你自己的代码。

通过隔离持久性，您可以生成存根存储库来模拟数据提供者，以便创建第一个 PoC(例如)和模拟业务服务。

六边形架构产品可以使用适配器在它们之间进行通信。想想微服务架构风格，是完全适用的，如果你把每个微服务看成是自己的六边形架构产品，传输通信层作为它们之间的适配器(HTTP，gRPC，Pub/Sub)。

> 将架构模式视为工具箱或指南，而不是在任何情况下应用它们的真理来源。

## 结论

我知道，我们每天都必须加快工作速度，而质量(还有安全性)是第一个要放弃的特性。通过专注于业务问题，并使用架构模式作为工具，您将有空闲时间，这通常是通过一次又一次地重新发明轮子来花费的，以产生可证明的价值，并使维护者和审计者快乐。

> 把维护者想象成一个彻头彻尾的精神病患者，他知道你住在哪里，并且想杀了你...当你写代码的时候。

# 参考文献

*   [Github Spotigraph](https://github.com/Zenithar/go-spotigraph)
*   [洁净的建筑](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
*   [DDD、六角形、洋葱、干净、CQRS……我是如何把它们组合在一起的](https://herbertograca.com/2017/11/16/explicit-architecture-01-ddd-hexagonal-onion-clean-cqrs-how-i-put-it-all-together/)

[来自我博客的原始帖子](https://blog.zenithar.org/post/2019/05/13/how-i-write-a-micro-service-part-1/)