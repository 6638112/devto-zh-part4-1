# 优雅关机是个谎言

> 原文:[https://dev.to/samthor/graceful-shutdown-is-a-lie-n79](https://dev.to/samthor/graceful-shutdown-is-a-lie-n79)

如果你正在编写后端代码，你应该总是假设你的服务将会崩溃。💥

这是我在设计使用 [Megastore](https://ai.google/research/pubs/pub36971) 执行(有效)交易的可靠代码时学到的。这种服务需要始终处于活动状态:我们的失败案例是它崩溃了，或者我们正在升级二进制文件。

这对于 web 服务器来说是很容易理解的，例如，一个节点服务器只能通过 Ctrl-C 关闭，或者一个 Go 服务器只能“失败”:

```
func main() {
  http.Handle("/foo", fooHandler)
  log.Fatal(http.ListenAndServe(":8080", nil))
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

但是当执行一些操作时，比如数据库或文件操作，崩溃意味着什么就不太清楚了。你的服务器什么时候会尴尬的崩溃？

*   当你把一个文件写到磁盘上覆盖一个以前的文件时:有一段时间，*和*文件都不存在

    *   ...解决方法是写一个临时文件并替换之前的文件
*   更新合计计数(例如，当您插入一行时，将“总计”加 1):如果第二个操作失败

    *   ...用数据库事务解决
*   将电子邮件标记为已发送:如果数据库出现故障怎么办？

    *   ...发第二封邮件可能没问题，\_(ツ)_/

在所有这些情况下，防御性编码是值得的。这不是一篇很长的文章，但只是想一想:在什么情况下🔌从您的提供商处断开？有什么风险？

# [](#thanks)谢谢！

Nineteen