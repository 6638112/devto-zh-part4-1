# Azure 架构冒险:家庭桌面设置

> 原文：<https://dev.to/seankilleen/adventures-in-azure-architecture-a-home-desktop-setup-52c0>

我最近在 Twitter 上联系了一个人，他对云中个人设置的架构有一些疑问。我觉得这个挑战很有趣，所以下面是这个问题的参数，以及我是如何试图为她设计一个解决方案的(从现在开始，我一般称她为“客户”，尽管钱在这里不会转手)。

## 背景/目标

客户要搬到海外，无法随身携带他们的桌面设备，因为他们没有地方存放这些设备。他们以前将该台式机用作中央计算机，在旅行等过程中使用它。–并且希望重新创建这种中心位置，而不局限于桌面硬件的物理存在。

## 所述的约束

*   **完全基于云**:客户希望其计算环境主要基于云
*   **数据安全是必须的**:客户过去曾有过备份灾难。确保他们的所有数据不会消失是最重要的。
*   **Windows 工作负载**:客户端全天主要使用 Windows。
*   Azure:客户主要对 Azure 服务感兴趣

## 我问的附加问题

*   **什么样的数据/信息？**偶尔的图形密集型工作负载(想想 Adobe Photoshop&InDesign)；Outlook 电子邮件文件；Audacity 音乐文件
*   **预算**:一般来说，她希望在 3 年内保持新硬件的价格，所以考虑 1000 美元/年或 83 美元/月。
*   **扩展预算**:客户提到，如果交付该解决方案，他们可能每月支付大约 200 美元，这确实给了我们一些回旋余地。
*   客户(大概)会在哪里？客户将位于英国，但有一些数据不能跨越边界，所以东西可以位于美国(他们知道滞后的可能性)。
*   **客户预计每天使用机器的时间有多长？**顾客每天使用机器大约 2-3 小时。假设我们可以将工具安装到位，我们可以用它来推断成本。
*   **大致有多少数据？6tb，但是客户觉得他们可以削减到 2 TB。这将影响我们对虚拟机备份等成本的理解**

## 我的方法

好的，这是很多有用的信息。我是这么想的:

*   我认为客户会从 Office365 订阅中受益。这将为她在旅途中可能需要的大量 office 应用程序的 web 访问做好准备，还将为她提供 1 TB 的 OneDrive 存储空间(稍后将详细介绍)。
*   **OneDrive 用于数据存储**:我认为云同步服务非常有意义，并且我认为将 OneDrive 用作中央文件存储点有几个优点。任何添加到那里的文件都将被同步，微软已经在这个系统的弹性上投入了大量的金钱/精力。比起我自己开发的解决方案，我更信任拥有这些资源的公司。此外，如果我们在桌面上设置 OneDrive，我们只需同步我们实际使用的文件，这意味着大量数据可以存储在云中，而无需在虚拟机硬盘上花费资金。最后，如果她订阅 Office365，她可以以 99 美元/年的价格获得 1TB 存储，在我看来这是一笔划算的交易。如果你是一个人，OneDrive 技术上可以为你提供 5 TB 存储。您可以创建多达 5 个帐户，每个帐户 1 TB 的存储空间，并在他们之间共享文件夹。
*   **虚拟机选择**:据我所知，我认为`D4s v3`虚拟机最有意义。在紧要关头，4 个 CPU 和 16 GB RAM 对于大多数处理应该足够了。
*   另一种选择:第二个高负载虚拟机:设置类似，但使用频率较低，高负载虚拟机可以有更高的规格。这将允许客户端每天产生较低的成本，然后在需要时转到更高规格的虚拟机，以完成更密集的工作。如果我们已经在云中存储了大部分数据，那么只需要几分钟的同步时间和偶尔的应用升级/维护，就可以让那里的数据保持最新。
*   **附加数据选项:虚拟机硬盘**:由于该客户特别关注数据保护，她可能会选择在多个位置备份数据。他们可以做到这一点的一种方法是在虚拟机上安装一个低性能硬盘，并确保 OneDrive 在该硬盘上保留所有文件的副本。他们会为存储空间付费，但现在他们总是将文件放在两个位置。
*   **附加数据选项:Backblaze** :客户端也可以添加 Backblaze 订阅，并将这些文件发送到 Backblaze 云。在这种情况下，她会有一个存储文件的云提供商，在虚拟机上有一个副本以防云变得可访问，并在 backblaze 中有一个额外的备份(如果她需要支付费用，也可以在必要时为她提供一个硬盘)
*   **附加数据选项:虚拟机硬盘备份**:我相信有了虚拟机硬盘，您也可以将它作为备份进行地理复制
*   **Chocolatey 包管理**:我推荐通过 Chocolatey(一个可爱的免费工具)安装应用程序，因为你可以导出一个文件，这样你就可以非常快速地再次设置你的虚拟机的应用程序，如果你出于某种原因需要重新创建你的设置。
*   **附加保护:虚拟机备份**:你可以在 Azure 中备份整个虚拟机。
*   **计划关闭**:为了确保不必要的成本不会累积，我们希望在预期使用时间之外关闭虚拟机。这可以通过 Azure 门户实现(假设一个时间表实际上适用于客户的工作时间)。
*   **快速&轻松开/关**:客户端应该能够在需要时轻松准备好机器以供使用，并在使用完毕后将其关闭，因为虚拟机是按秒计费的，因此不使用它的任何一秒都是省钱的。由于我们将在 Azure 中，我想我们将设置一个 Azure 函数或 bot 框架部署，链接到某种传入通道(电子邮件、文本消息)，以便客户端可以轻松地发送开/关命令来启动或关闭虚拟机。这让它成为他们日常使用的一个自然部分，而不需要承担“永远在线”机器的成本。

## 取舍

*   **数据安全问题与成本效益**:客户提出了(完全合理的)观点，即 MS 持有 OneDrive 存储的加密密钥，因此他们通常在那里保留最少的文件。然而，连接到 Azure 虚拟机的 2 TB 磁盘(不包括备份成本)可能会达到每月 80-100 美元，这与预算限制不符。
*   **图形**:客户提到 Adobe Photoshop / InDesign 等。这种解决方案的一个弱点是，这种设置中的机器没有独立显卡。我不确定该怎么办，也不确定总体影响会是什么。

## 计算成本

我用 Azure 价格计算器试图快速估算一下。

| 项目 | 使用 onedrive 存储 | No OneDrive | 笔记 |
| --- | --- | --- | --- |
| **普通虚拟机** |  |  |  |
| 机器 | $36.55 | $36.55 | 2 个 vCPU，8 GB 内存。假设每天使用 6 小时。 |
| 储存；储备 | $19 | $82 | 这是一个标准硬盘驱动器；固态硬盘的价格是 153 美元。如果使用 OneDrive，则假定为 256 GB，因为如果 one drive 驻留在云上，则大部分都是如此。 |
| 虚拟机备份 | $10 | $50 |  |
| **“高强度使用”虚拟机** |  |  | 较少使用，用于要求更高的工作负载 |
| 机器 | $3.78 | $3.78 | 4 个 vCPU，32 GB 内存。假设每月使用*6 小时*。 |
| 储存；储备 | $9.60 | $9.60 | SSD，64 GB(假设她会用这个来工作，然后在其他地方存储东西)。 |
| 虚拟机备份 | $10 | $10 |  |
| **Backblaze 订阅** | $0 | $6 | 如果不是主要在 OneDrive 等自动备份系统上存储内容，建议使用 |
|  |  |  |  |
| **月总量** | $89 | $198 |  |

看起来我们的预算还算合理！

## 肘子油脂&其他建议

*   **这假设我们构建了一个小触发器来打开/关闭虚拟机**:为了实现这个解决方案，我们将不得不使用 Azure 函数或 Bot 框架，它们基本上可以免费实现，但需要一点时间来弄清楚。
*   **找到数据重要性的层次**:家庭照片与已经存储在另一台服务器上的电子邮件不同。对于最重要的内容，将其放在 OneDrive 和备份的虚拟机磁盘上。然后，您将拥有一个云同步、一个单独的位置以及该单独位置的备份。如果您在虚拟机磁盘上添加 Backblaze，这也为您提供了一个额外的备份提供商。

## 我做得怎么样？我错过了什么？

这是一个有趣的练习。但是亲爱的读者，这个解决方案是如何形成的呢？有什么事情你会有不同的计划/做法吗？我很想在评论中听到它！